<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ระบบขายหน้าร้าน (POS) - UI ใหม่</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
    :root {
        --primary-color: #005cbf;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
        --light-bg: #f8f9fa;
        --white-color: #ffffff;
        --dark-text: #343a40;
        --border-color: #dee2e6;
        --shadow: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
        /* [ADJUSTED] ระยะห่างหลักแบบกระชับ */
        --gap: 1.2rem;
    }

    body {
        font-family: 'Sarabun', sans-serif;
        background-color: var(--light-bg);
        color: var(--dark-text);
        margin: 0;
        height: calc(var(--vh) * 100);
        overflow: hidden;
        /* [ADJUSTED] ขนาดฟอนต์หลักแบบกระชับ */
        font-size: 1.13em;
    }

    .app-layout {
        display: grid;
        grid-template-columns: 30% auto;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
    }

    /* --- [MODIFIED] Sidebar (ย้ายไปอยู่ข้างแท็บตะกร้า) --- */
    #app-sidebar {
        display: flex; /* เปลี่ยนเป็น Flexbox */
        gap: 0.5rem;   /* ลดระยะห่าง */
        /* ลบสไตล์การจัดวางเดิมทั้งหมด */
    }

    /* [MODIFIED] ปรับดีไซน์ปุ่ม Sidebar ใหม่ให้เข้ากับแท็บ */
    .sidebar-btn {
        background-color: transparent;
        border: 1px solid transparent;
        width: auto;
        height: auto;
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: row; /* จัดแนวนอน */
        align-items: center;
        justify-content: center;
        color: var(--secondary-color);
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        font-size: 0.9em;
        font-weight: normal;
        gap: 6px; /* ระยะห่างระหว่างไอคอนกับข้อความ */
    }
    .sidebar-btn svg {
        width: 20px; /* ลดขนาดไอคอน */
        height: 20px;
        margin-bottom: 0; /* ลบระยะห่างล่าง */
    }
    .sidebar-btn:hover {
        background-color: #f1f3f5; /* ทำให้ hover ดูนุ่มนวลขึ้น */
        color: var(--primary-color);
    }
    .sidebar-btn.active {
        background-color: #e7f1ff;
        color: var(--primary-color);
        border-color: #a8c7fa; /* เส้นขอบเมื่อ active */
        font-weight: bold;
    }
    /* --- Main Content Columns --- */
    .search-column {
        padding: var(--gap);
        height: calc(var(--vh) * 100);
        box-sizing: border-box;
        display: flex;
    }
    .cart-column {
        padding: var(--gap) var(--gap) var(--gap) 0;
        height: calc(var(--vh) * 100);
        box-sizing: border-box;
        display: flex;
    }

    .card {
        background-color: var(--white-color);
        padding: 1.2rem;
        border-radius: 10px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    /* [FINAL UPDATE - REDUCED] เพิ่ม Padding ให้ Card ในส่วนตะกร้าใหญ่ขึ้น */
    .cart-column .card {
        padding: 1.425rem; /* ลดจาก 1.5rem */
    }

    h2, h3 {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.6rem;
        margin-top: 0;
        margin-bottom: 1.2rem;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-shrink: 0;
    }

    h3 { font-size: 1.2rem; margin-bottom: 1rem; }
    h4 { margin: 0; color: var(--dark-text); font-size: 1.1rem; }

    .filter-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: end; margin-bottom: 1.2rem; }
    .filter-group { display: flex; flex-direction: column; }
    .filter-group label { margin-bottom: 0.4rem; font-size: 0.9em; color: var(--secondary-color); font-weight: bold; }

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* ปรับความกว้างขั้นต่ำเล็กน้อย */
    gap: 1rem; /* [ปรับปรุง] เพิ่มระยะห่างระหว่างกล่องให้มากขึ้น */
    text-align: center;
}
.summary-item {
    background-color: #f1f3f5;
    padding: 0.8rem 0.5rem; /* [ปรับปรุง] เพิ่มระยะห่างภายใน (บน-ล่าง) */
    border-radius: 8px; /* [ปรับปรุง] ทำให้มุมโค้งมนมากขึ้น ดูนุ่มนวลขึ้น */
    border: 1px solid #e0e0e0;
}
.summary-item .label {
    font-size: 0.85em; /* [ปรับปรุง] เพิ่มขนาดตัวอักษรหัวข้อให้อ่านง่ายขึ้น */
    color: var(--secondary-color);
    margin-bottom: 0.4rem; /* [ปรับปรุง] เพิ่มระยะห่างจากตัวเลขมากขึ้น */
    display: block;
}
.summary-item .value {
    font-size: 1.6em; /* [ปรับปรุง] เพิ่มขนาดตัวเลขให้เด่นชัดขึ้น */
    font-weight: bold;
    color: var(--primary-color);
}
    #sales-summary-section h3 { font-size: 1.1rem; margin-bottom: 0.8rem; }


    .form-group { margin-bottom: 1rem; }
    .form-group label { font-size: 0.85em; color: var(--secondary-color); display: block; margin-bottom: 0.4rem; }

    .input-with-icon { position: relative; }
    .input-with-icon .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--secondary-color); pointer-events: none; }
    .input-with-icon input { padding-left: 36px; }

    input, select {
        width: 100%;
        padding: 0.6rem 0.8rem;
        font-size: 0.95em;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-family: 'Sarabun', sans-serif;
        transition: border-color 0.3s, box-shadow 0.3s;
        background-color: var(--white-color);
        height: 38px;
    }
    input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    
    /* [MODIFIED] แก้ไข Layout ของส่วนค้นหา */
    #main-search-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
    }

    #search-results {
        margin-top: 1rem;
        overflow-y: auto;
        border: 1px solid transparent;
        border-radius: 8px;
        flex-grow: 1;
    }
    #search-results.has-results { border-color: var(--border-color); background: #fff; }

    .search-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.88em; /* ลดขนาดลง 20% จาก 0.95em */
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover, .search-item.selected { background-color: var(--primary-color); color: var(--white-color); }
    
    .search-item .price {
        color: var(--success-color);
        font-weight: bold;
    }
    .search-item.selected .price, .search-item.selected .sub-text { color: var(--white-color); }

    .search-item .sub-text { font-size: 0.8em; color: var(--secondary-color); font-weight: normal; }
    .search-item .highlight { background-color: var(--warning-color); border-radius: 3px; padding: 0 4px; color: var(--dark-text); }
    .search-item.selected .highlight { background-color: #ffdd72; }

    /* [NEW] Styles for shortcut hints below search results */
    #shortcut-hints {
        padding: 0.8rem 0.5rem 0.2rem;
        margin-top: 0.5rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        font-size: 0.8em;
        color: var(--secondary-color);
        flex-shrink: 0; /* Prevent it from shrinking if space is tight */
        line-height: 1.4;
    }

    /* [FINAL UPDATE - REDUCED] เพิ่มขนาด Font ของหัวตารางตะกร้า */
    .cart-header-row {
        display: grid;
        grid-template-columns: 25px 2fr 70px 90px 90px 35px;
        gap: 0.4rem;
        padding: 0 0.8rem 0.4rem 0.8rem;
        font-weight: bold;
        font-size: 0.95em; /* ลดจาก 1em */
        color: var(--secondary-color);
        border-bottom: 2px solid var(--border-color);
        align-items: center;
        text-align: center;
        flex-shrink: 0;
    }
    .cart-header-row .col-name { text-align: left; }
    .cart-header-row .col-right { text-align: right; }

    #cart-items { list-style-type: none; padding: 0; overflow-y: auto; margin-top: 0.5rem; flex-grow: 1; }
    /* [FINAL UPDATE - REDUCED] เพิ่มขนาด Font ของรายการสินค้าในตะกร้า */
    #cart-items li {
        padding: 0.19rem 0.76rem; /* ลดจาก 0.2rem 0.8rem */
        border-radius: 6px;
        margin-bottom: 2px;
        display: grid;
        grid-template-columns: 25px 2fr 70px 90px 90px 35px;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.9025em; /* ลดจาก 0.95em */
        transition: background-color 0.2s;
        border: 1px solid transparent;
    }
    #cart-items li:nth-child(even) { background-color: #f8f9fa; }
    #cart-items li:hover { background-color: #e9ecef; border-color: var(--border-color); }
    #cart-items li.highlight-quantity { background-color: #fff3cd; border-left: 4px solid var(--warning-color); }
    #cart-items li.highlight-quantity:hover { background-color: #ffeeba; }
    /* [NEW] Add cursor for items with promotions */
    #cart-items li.has-promotion {
        cursor: help;
        border-left: 4px solid var(--info-color);
    }
    #cart-items .col-name { text-align: left; }
    #cart-items .col-seq, #cart-items .col-delete { text-align: center; }
    #cart-items .col-price, #cart-items .col-total { text-align: right; }

    .item-input { text-align: right; border: 1px solid var(--border-color); border-radius: 5px; padding: 4px 6px; font-size: 0.95em; background-color: var(--white-color); width: 100%; box-sizing: border-box; -moz-appearance: textfield; height: 28px;}
    .item-input::-webkit-outer-spin-button, .item-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .col-qty .item-input { width: 55px; text-align: center; margin: auto; }

    .delete-item-btn { background: transparent; border: none; color: var(--danger-color); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, background-color 0.2s; border-radius: 50%; width: 28px; height: 28px; }
    .delete-item-btn:hover { transform: scale(1.1); background-color: #fce8e6; }
    .delete-item-btn svg { width: 16px; height: 16px; }

    /* --- CSS for Totals and Promotion Section --- */
    .totals-section {
        padding-top: 0.95rem;
        border-top: 2px solid var(--border-color);
        margin-top: auto; /* Push to the bottom */
        flex-shrink: 0;
        display: flex; /* Use flexbox for layout */
        justify-content: flex-end; /* Align children to the end (right) */
        align-items: flex-end; /* Align to the bottom */
        gap: 1rem;
    }

    /* [MODIFIED] Set width for summary */
    .totals-summary {
        width: 60%;
        min-width: 350px; /* Ensure it doesn't get too squished */
    }
    /* --- End of Modified CSS --- */


    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.14em; 
        align-items: center;
    }
    .total-row label, .total-row span { font-weight: bold; }
    #discount-input { width: 70px; font-size: 1em; text-align: right; height: 28px; padding: 4px 6px; }
    #cart-total {
        color: var(--success-color);
        font-size: 1.805em; 
    }

    .button-group { display: flex; gap: 0.8rem; margin-top: 1.2rem; }

    .button-group-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.8rem;
        flex-shrink: 0;
        width: 100%; /* Button group inside summary now takes 100% of its parent */
        margin-left: auto;
        margin-top: 0.8rem; /* Add some space above buttons */
    }

    button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        font-family: 'Sarabun', sans-serif;
        transition: background-color 0.3s, transform 0.1s, filter 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 1px solid transparent;
        height: 38px;
        font-weight: bold;
    }
    button:hover { filter: brightness(115%); }
    button:disabled { background-color: #6c757d; cursor: not-allowed; filter: grayscale(50%); }
    button:active { transform: scale(0.98); }
    button.finish-sale { background-color: var(--success-color); border-color: var(--success-color); }
    button.clear-cart { background-color: var(--danger-color); border-color: var(--danger-color); }
    .delete-history-btn { background-color: var(--danger-color); padding: 0.25rem 0.6rem; font-size: 0.85em; }
    .edit-history-btn { background-color: var(--info-color); padding: 0.25rem 0.6rem; font-size: 0.85em; }
    .print-history-btn { background-color: var(--secondary-color); padding: 0.25rem 0.6rem; font-size: 0.85em; margin-right: 5px; }


    #history-table-wrapper { flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    #history-table { width: 100%; border-collapse: collapse; }
    #history-table th, #history-table td {
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
        text-align: left;
        vertical-align: middle;
        font-size: 0.9em;
    }
    #history-table th { background-color: #f1f3f5; position: sticky; top: 0; z-index: 10; font-weight: bold; font-size: 0.95em; }
    #history-table tr:nth-child(even) { background-color: var(--light-bg); }
    #history-table tr:hover { background-color: #e9f5ff; }
    #history-table tr.exported-row { background-color: #f1f8e9; opacity: 0.8; }
    #history-table tr.exported-row:hover { opacity: 1; }
    #history-table tr.exported-row td { color: #555; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--white-color); border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); width: 90%; max-width: 550px; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border-color); }
    .modal-header h3 { margin: 0; border: none; }
    .modal-body { padding: 1.5rem; flex-grow: 1; overflow-y: auto; }
    .modal-footer { padding: 1.2rem 1.5rem; border-top: 1px solid var(--border-color); background-color: var(--light-bg); display: flex; justify-content: center; align-items: center; }
    .modal-footer .button-group { margin-top: 0; justify-content: center; }
    .modal-content p { white-space: pre-wrap; text-align: left; margin-bottom: 1.2rem; line-height: 1.6; }
    .payment-modal-body { width: 100%; }
    .payment-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .payment-row:last-child { border-bottom: none; margin-bottom: 0; }
    .payment-label { font-size: 1.8em; color: var(--secondary-color); font-weight: bold; }
    .payment-amount { font-weight: bold; }
    #payment-total-final { font-size: 3.2em; color: var(--primary-color); }
    #cash-received-input { font-size: 2.8em; text-align: right; width: 50%; height: 60px; padding: 5px 10px; }
    #payment-change { font-size: 3.5em; color: var(--success-color); }
    
    .cart-tabs-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 0.3rem;
        flex-shrink: 0;
        gap: 0.5rem;
    }

    /* [NEW] Wrapper for tabs and the add button */
    #cart-tabs-wrapper {
        display: flex;
        align-items: center;
        flex-grow: 1;
        overflow: hidden; /* Hide overflowing tabs */
    }

    #cart-tabs { display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; }
    .tab-button { padding: 0.7rem 1.1rem; cursor: pointer; background-color: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; font-size: 0.95em; color: var(--secondary-color); position: relative; flex-shrink: 0; transition: color 0.3s, border-color 0.3s; }
    .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
    .close-tab-btn { background: none; border: none; color: inherit; font-size: 1.2em; padding: 0 0 0 0.6rem; line-height: 1; opacity: 0.5; border-radius: 50%; }
    .close-tab-btn:hover { opacity: 1; background-color: rgba(0,0,0,0.1); }
    
    /* [NEW] Styles for the "Add New Tab" button */
    #add-new-tab-btn {
        background-color: #e9ecef;
        border: 1px solid transparent;
        color: var(--secondary-color);
        width: 34px;
        height: 34px;
        min-width: 34px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        padding: 0;
        margin-left: 0.5rem;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        margin-bottom: -2px; /* Align with tabs */
    }
    #add-new-tab-btn:hover {
        background-color: var(--primary-color);
        color: var(--white-color);
        border-color: var(--primary-color);
        filter: brightness(100%);
    }
    #add-new-tab-btn svg {
        width: 20px;
        height: 20px;
    }

    #product-mgmt-modal .modal-content, #history-modal .modal-content, #settings-modal .modal-content { max-width: 95vw; width: 1400px; height: 95vh; }
    .modal-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
    .modal-toolbar h2 { margin: 0; border: none; font-size: 1.4rem; }
    #product-list-container { flex-grow: 1; overflow-y: auto; }
    .product-list-row { display: grid; grid-template-columns: 2fr 1fr 1.5fr 150px; gap: 1rem; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color); align-items: center; transition: background-color 0.2s; font-size: 0.9em; }
    .product-list-row:last-child { border-bottom: none; }
    .product-list-row.product-list-header { background-color: var(--light-bg); font-weight: bold; position: sticky; top: 0; z-index: 1; font-size: 0.95em; }
    .product-list-row:not(.product-list-header):hover { background-color: #e9f5ff; }
    #product-editor-modal .modal-content { max-width: 1200px; width: 90vw; height: 85vh; padding: 0; }
    #product-editor-form { display: flex; flex-direction: column; overflow: hidden; height: 100%; }
    .form-content-area { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .form-column-left, .form-column-right { display: flex; flex-direction: column; }
    .pricing-unit-card { border: 1px solid var(--border-color); border-radius: 10px; padding: 1.2rem; margin-bottom: 1.2rem; background-color: #fdfdfd; }
    .pricing-unit-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; margin-bottom: 1.2rem; }
    .pricing-unit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; }
    #pricing-units-container { flex-grow: 1; }
    .price-tiers-container { margin-top: 1.2rem; }
    .price-tier-header { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 0.75rem; font-size: 0.85em; color: var(--secondary-color); padding: 0 4px; margin-bottom: 0.5rem; }
    .price-tier-row { display: grid; grid-template-columns: 1fr 1fr 40px; gap: 0.75rem; align-items: center; margin-bottom: 0.75rem; }
    .add-tier-btn { padding: 0.5rem; font-size: 0.9em; background-color: var(--secondary-color); }
    #add-pricing-unit-btn { background-color: var(--info-color); margin-top: 1rem; }
    #product-list-pagination { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
    .pagination-controls button { background-color: var(--white-color); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 0.4rem 0.8rem; margin: 0 0.25rem; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s; height: auto; min-width: 36px; }
    .pagination-controls button:hover:not(:disabled) { background-color: var(--primary-color); color: var(--white-color); filter: brightness(100%); }
    .pagination-controls button.active { background-color: var(--primary-color); color: var(--white-color); font-weight: bold; }
    .pagination-controls button:disabled { background-color: var(--light-bg); border-color: var(--border-color); color: var(--secondary-color); cursor: not-allowed; opacity: 0.6; }

    /* [NEW] Styles for Promotion Tooltip */
    #promotion-tooltip {
        display: none;
        position: fixed;
        background-color: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        padding: 1rem;
        z-index: 1001;
        max-width: 300px;
        pointer-events: none; /* Prevent tooltip from blocking mouse events */
        font-size: 0.85em;
        line-height: 1.6;
    }
    #promotion-tooltip h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1em;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.4rem;
    }
    #promotion-tooltip ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    #promotion-tooltip li {
        margin-bottom: 0.25rem;
    }
    #promotion-tooltip .highlight {
        font-weight: bold;
        color: var(--dark-text);
        background-color: var(--warning-color);
        padding: 1px 4px;
        border-radius: 3px;
    }


    /* Responsive */
    @media (max-width: 992px) {
        body { overflow: auto; height: auto; }
        .app-layout { display: block; }
        .search-column, .cart-column { width: 100%; min-height: 450px; padding: var(--gap); }
        .cart-column { padding-top: 0; }
        #app-sidebar {
            margin-top: var(--gap);
        }
        #product-editor-modal .form-content-area { grid-template-columns: 1fr; }
        .filter-section { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
        .search-column, .cart-column { padding: 0.5rem; }
        .card { padding: 1rem; }
        h2, h3 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }
        .summary-grid { gap: 0.5rem; }
        .summary-item .value { font-size: 1.5em; }
        .payment-label { font-size: 1.2em; }
        #payment-total-final { font-size: 2em; }
        #cash-received-input { font-size: 1.5em; }
        #payment-change { font-size: 2.2em; }
        #cart-items li, .cart-header-row { gap: 0.5rem; grid-template-columns: 30px 1.5fr 70px 80px 80px 40px; }
        .col-qty .item-input { width: 50px; }
        .delete-item-btn, .close-tab-btn { width: 30px; height: 30px; font-size: 1.2em; }
        .pricing-unit-grid { grid-template-columns: 1fr; }
        #product-list-pagination { flex-wrap: wrap; }
        .pagination-controls button { padding: 0.4rem 0.8rem; }
    }

#history-filter-section {
    display: grid;
    grid-template-columns: 1.5fr 2.5fr 1fr;
    gap: 1.2rem;
    align-items: end;
    margin-bottom: 1.2rem;
}

@media (max-width: 1200px) {
    #history-filter-section {
        grid-template-columns: 1fr;
    }
}

/* -----------------------------
   Highlight ไล่สีตามจำนวน
------------------------------*/
#cart-items li[data-qty="1"] { background-color: rgba(255,193,7,0.15); }
#cart-items li[data-qty="2"] { background-color: rgba(255,193,7,0.25); }
#cart-items li[data-qty="3"] { background-color: rgba(255,193,7,0.35); }
#cart-items li[data-qty="4"] { background-color: rgba(255,193,7,0.45); }
#cart-items li[data-qty="5"] { background-color: rgba(255,193,7,0.55); }
#cart-items li[data-qty="6"] { background-color: rgba(255,193,7,0.65); }

/* -----------------------------
   Responsive Compact Mobile
------------------------------*/
@media (max-width: 576px) {
    .cart-header-row {
        grid-template-columns: 25px 2fr 1fr 1fr;
    }
    #cart-items li {
        grid-template-columns: 25px 2fr 1fr 1fr;
    }
    .cart-header-row .col-price,
    #cart-items .col-price {
        display: none;
    }
}


/* ==== Compact Pro overrides for auth status + app sidebar ==== */
.auth-status-badge{
  display:flex;
  align-items:center;
  gap:.4rem;
  padding:.22rem .6rem;
  background:#fff;
  border:1px solid var(--border-color);
  border-radius:999px;
  font-size:.82em;
  color:var(--secondary-color);
  box-shadow: var(--shadow);
  line-height:1;
}
.auth-status-badge .dot{
  width:8px;height:8px;border-radius:50%;
  background: var(--secondary-color);
}
.auth-status-badge.admin{ color:var(--primary-color); border-color:#bad4ff; }
.auth-status-badge.admin .dot{ background: var(--success-color); }
.auth-status-badge.user{ color:var(--dark-text); border-color:#d7e3ff; }
.auth-status-badge.user .dot{ background: var(--info-color); }
.auth-status-badge.offline{ opacity:.9; }
.auth-status-badge.offline .dot{ background: var(--danger-color); }

/* Toolbar alignment inside cart header */
.cart-tabs-container{
  gap:.4rem;
}
#cart-tabs-wrapper{ min-width:0; } /* allow tabs to shrink */
#auth-status{ flex-shrink:0; }

/* Sidebar as compact icon toolbar */
#app-sidebar{
  display:flex;
  align-items:center;
  gap:.25rem;
  margin-left:.25rem;
  flex-shrink:0;
}
.sidebar-btn{
  background:transparent;
  border:1px solid transparent;
  padding:.38rem;
  height:34px;
  min-width:34px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  color:var(--secondary-color);
  transition:background-color .2s, color .2s, border-color .2s, filter .2s;
  gap:.35rem;
}
.sidebar-btn svg{ width:18px; height:18px; }
.sidebar-btn span{ display:none; } /* icon-first compact */
.sidebar-btn:hover{ background:#f1f3f5; color:var(--primary-color); }
.sidebar-btn.active{ background:#e7f1ff; color:var(--primary-color); border-color:#a8c7fa; font-weight:600; }

/* Expand labels on wider screens */
@media (min-width: 1360px){
  .sidebar-btn{ padding:.38rem .55rem; min-width:auto; }
  .sidebar-btn span{ display:inline; font-size:.9em; }
}

/* Tighten mobile spacing */
@media (max-width:768px){
  .auth-status-badge{ font-size:.78em; padding:.2rem .5rem; }
  .sidebar-btn{ height:32px; }
}


/* ==== Ultra-Compact v2 for auth-status + app sidebar ==== */
.auth-status-badge{
  gap:.30rem;
  padding:.16rem .44rem;
  font-size:.78em;
  letter-spacing:.01em;
}
.auth-status-badge .dot{ width:6px;height:6px; }
.auth-status-badge .name,.auth-status-badge .role,.auth-status-badge .email{
  max-width:12ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
/* Hide auth-status on narrow screens to free space */
@media (max-width:900px){ #auth-status{ display:none; } }

/* Sidebar tighter */
#app-sidebar{ gap:.15rem; margin-left:.15rem; }
.sidebar-btn{
  padding:.28rem;
  height:30px; min-width:30px;
  border-radius:7px;
  gap:.30rem;
}
.sidebar-btn svg{ width:16px; height:16px; }
/* Labels only on very wide screens */
@media (min-width:1600px){
  .sidebar-btn{ padding:.34rem .5rem; }
  .sidebar-btn span{ display:inline; font-size:.85em; }
}
/* Extra tight on small desktops */
@media (max-width:1280px){
  .sidebar-btn{ height:28px; min-width:28px; }
}
.cart-tabs-container{ gap:.25rem; }
#cart-tabs-wrapper{ min-width:0; }


/* ==== Unified UI tokens and styles (auth-status + app sidebar) ==== */
:root{
  --ui-height:30px;
  --ui-radius:999px;
  --ui-gap:.25rem;
  --ui-pad-x:.5rem;
  --ui-font:.78em;
  --ui-icon:16px;
  --ui-border:1px solid var(--border-color);
  --ui-bg:#fff;
  --ui-hover:#f3f5f7;
  --ui-active:#e7f1ff;
  --ui-ring:0 0 0 2px rgba(88,135,255,.25);
}

/* Base: same visual language for both */
.auth-status-badge,
#app-sidebar .sidebar-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:var(--ui-height);
  border-radius:var(--ui-radius);
  font-size:var(--ui-font);
  line-height:1;
  gap:var(--ui-gap);
  background:var(--ui-bg);
  border:var(--ui-border);
  color:var(--secondary-color);
  box-shadow: var(--shadow);
}

/* Auth badge specifics */
.auth-status-badge{ padding:.12rem var(--ui-pad-x); }
.auth-status-badge .dot{ width:6px; height:6px; border-radius:50%; }
.auth-status-badge .name,.auth-status-badge .role,.auth-status-badge .email{
  max-width:12ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.auth-status-badge.admin{ color:var(--primary-color); border-color:#bad4ff; }
.auth-status-badge.admin .dot{ background: var(--success-color); }
.auth-status-badge.user{ color:var(--dark-text); border-color:#d7e3ff; }
.auth-status-badge.user .dot{ background: var(--info-color); }
.auth-status-badge.offline .dot{ background: var(--danger-color); }

/* Sidebar button specifics */
#app-sidebar{
  display:flex; align-items:center; gap:.15rem; margin-left:.15rem; flex-shrink:0;
}
#app-sidebar .sidebar-btn{
  padding:.28rem var(--ui-pad-x);
  min-width:var(--ui-height);
  background:transparent; /* base transparent, hover shows bg */
  border:1px solid transparent;
}
#app-sidebar .sidebar-btn svg{ width:var(--ui-icon); height:var(--ui-icon); }
#app-sidebar .sidebar-btn span{ display:none; }

/* States: shared */
.auth-status-badge:hover, #app-sidebar .sidebar-btn:hover{
  background:var(--ui-hover); color:var(--primary-color);
}
#app-sidebar .sidebar-btn.active, .auth-status-badge.active{
  background:var(--ui-active); color:var(--primary-color); border-color:#a8c7fa; font-weight:600;
}
.auth-status-badge:focus-visible, #app-sidebar .sidebar-btn:focus-visible{
  outline:none; box-shadow: var(--ui-ring);
}

/* Responsiveness */
@media (max-width:900px){ #auth-status{ display:none; } }
@media (max-width:1280px){ #app-sidebar .sidebar-btn{ height:28px; min-width:28px; } }
@media (min-width:1600px){
  #app-sidebar .sidebar-btn span{ display:inline; font-size:.85em; }
  #app-sidebar .sidebar-btn{ padding:.34rem .6rem; }
}

/* Tighten tab area to match spacing */
.cart-tabs-container{ gap:.25rem; }
#cart-tabs-wrapper{ min-width:0; }

/* End unified layer */


/* ==== Readability Boost: slightly larger tokens ==== */
:root{
  --ui-height:34px;     /* was 30px */
  --ui-icon:18px;       /* was 16px */
  --ui-font:.86em;      /* was .78em */
  --ui-pad-x:.6rem;     /* was .5rem */
  --ui-gap:.30rem;      /* was .25rem */
}


/* ==== Global Compact Design System (token-driven) ==== */
:root{
  /* Core tokens */
  --ui-height:34px;
  --ui-radius:12px;
  --ui-font:.86em;
  --ui-icon:18px;
  --ui-gap:.30rem;
  --pad-x:.7rem;
  --pad-y:.35rem;
  --space-1:.25rem; --space-2:.5rem; --space-3:.75rem;
  --border:1px solid var(--border-color);
  --surface:#fff;
  --surface-subtle:#fafbfc;
  --hover:#f3f5f7;
  --active:#e7f1ff;
  --ring:0 0 0 2px rgba(88,135,255,.25);
  --text-muted:#5b6675;
}
/* Density presets */
html.density-compact, body.density-compact{
  --ui-height:32px; --ui-font:.84em; --ui-icon:16px; --pad-x:.6rem; --pad-y:.3rem; --ui-radius:10px;
}
html.density-cozy, body.density-cozy{
  --ui-height:36px; --ui-font:.9em; --ui-icon:18px; --pad-x:.8rem; --pad-y:.38rem; --ui-radius:12px;
}
html.density-comfortable, body.density-comfortable{
  --ui-height:40px; --ui-font:.95em; --ui-icon:20px; --pad-x:1rem; --pad-y:.45rem; --ui-radius:14px;
}

/* ====== Primitives ====== */
button, .btn{
  display:inline-flex; align-items:center; gap:var(--ui-gap);
  height:var(--ui-height);
  padding:0 var(--pad-x);
  border-radius:var(--ui-radius);
  border:var(--border);
  background:var(--surface);
  color:var(--dark-text, #1f2937);
  line-height:1; white-space:nowrap;
  transition:background-color .15s, color .15s, border-color .15s, box-shadow .15s, transform .02s;
}
button:hover, .btn:hover{ background:var(--hover); color:var(--primary-color, #2952e3); }
button:active, .btn:active{ transform:translateY(0.5px); }
button:focus-visible, .btn:focus-visible{ outline:none; box-shadow:var(--ring); }
.btn svg{ width:var(--ui-icon); height:var(--ui-icon); }

.btn-primary{ background:var(--primary-color); color:#fff; border-color:transparent; }
.btn-primary:hover{ filter:brightness(1.02); }
.btn-ghost{ background:transparent; border-color:transparent; }
.btn-danger{ background:var(--danger-color, #e11d48); color:#fff; border-color:transparent; }

/* Inputs */
input[type="text"], input[type="search"], input[type="number"], input[type="email"],
select, textarea, .input, .select{
  height:var(--ui-height);
  padding:0 var(--pad-x);
  border-radius:var(--ui-radius);
  border:var(--border);
  background:#fff;
  font-size:var(--ui-font);
}
textarea{ min-height: calc(var(--ui-height) * 2); padding: var(--pad-y) var(--pad-x); }
input:focus, select:focus, textarea:focus, .input:focus{ outline:none; box-shadow:var(--ring); border-color:#a8c7fa; }
::placeholder{ color:var(--text-muted); }

/* Tabs */
.tabs{ display:flex; gap:var(--space-1); align-items:center; }
.tab{
  display:inline-flex; align-items:center; gap:.4rem;
  height:var(--ui-height); padding:0 .8rem;
  border-radius:999px; border:var(--border); background:var(--surface);
  color:var(--secondary-color);
}
.tab:hover{ background:var(--hover); color:var(--primary-color); }
.tab.active{ background:var(--active); color:var(--primary-color); border-color:#a8c7fa; font-weight:600; }

/* Table */
.table{ width:100%; border-collapse:separate; border-spacing:0; }
.table thead th{
  text-align:left; font-weight:600; font-size:calc(var(--ui-font) * .95);
  color:var(--text-muted); padding:.55rem .8rem; background:var(--surface-subtle);
  position:sticky; top:0; z-index:1;
}
.table tbody td{ padding:.55rem .8rem; border-top:var(--border); }
.table tbody tr:hover{ background:var(--hover); }
.table.zebra tbody tr:nth-child(even){ background:#fcfdff; }

/* Cards / Panels */
.card, .panel{
  background:var(--surface); border:var(--border); border-radius:16px;
  box-shadow:var(--shadow); padding:var(--space-3);
}
.card-header, .panel-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:var(--space-2); }
.card-footer, .panel-footer{ display:flex; gap:var(--space-2); justify-content:flex-end; margin-top:var(--space-2); }

/* Badges / Pills */
.badge, .pill{
  display:inline-flex; align-items:center; gap:.35rem; line-height:1;
  height:calc(var(--ui-height) - 8px);
  padding:0 .6rem; border-radius:999px; border:var(--border); background:var(--surface);
  font-size:calc(var(--ui-font) * .95);
}
.badge .dot, .pill .dot{ width:6px; height:6px; border-radius:50%; }
.badge.success .dot{ background:var(--success-color, #16a34a); }
.badge.info .dot{ background:var(--info-color, #0ea5e9); }
.badge.warn .dot{ background:#f59e0b; }
.badge.danger .dot{ background:var(--danger-color, #e11d48); }

/* Toolbar / Header */
.toolbar{ display:flex; align-items:center; gap:var(--space-1); }
.toolbar .spacer{ flex:1 1 auto; }

/* Pagination */
.pagination{ display:flex; align-items:center; gap:.25rem; }
.pagination .page, .pagination .prev, .pagination .next{
  height:var(--ui-height); min-width:var(--ui-height);
  display:inline-flex; align-items:center; justify-content:center;
  border:var(--border); border-radius:999px; background:var(--surface);
}
.pagination .page.active{ background:var(--active); border-color:#a8c7fa; font-weight:600; }

/* Switch / Checkbox / Radio */
.switch{ width:42px; height:22px; background:#e5e7eb; border-radius:999px; position:relative; transition:background .15s; }
.switch:before{ content:""; position:absolute; width:18px; height:18px; top:2px; left:2px; background:#fff; border-radius:50%; box-shadow:var(--shadow); transition:left .15s; }
.switch.on{ background:var(--primary-color); }
.switch.on:before{ left:22px; }

input[type="checkbox"].chk, .checkbox{ width:16px; height:16px; border:var(--border); border-radius:4px; }
input[type="radio"].radio, .radio{ width:16px; height:16px; border:var(--border); border-radius:50%; }

/* Modal */
.modal{ display:flex; align-items:center; justify-content:center; }
.modal .modal-dialog{ background:var(--surface); border:var(--border); border-radius:16px; width:min(720px, 92vw); }
.modal .modal-header, .modal .modal-footer{ padding:var(--space-2) var(--space-3); }
.modal .modal-body{ padding:var(--space-3); }
.modal .modal-header{ display:flex; align-items:center; justify-content:space-between; border-bottom:var(--border); }
.modal .modal-footer{ display:flex; gap:var(--space-2); justify-content:flex-end; border-top:var(--border); }

/* Tooltips */
.tooltip{ position:absolute; padding:.35rem .55rem; background:#111827; color:#fff; border-radius:8px; font-size:calc(var(--ui-font) * .9); box-shadow:var(--shadow); }

/* Navbar / Sidebar unify spacing */
.navbar{ display:flex; align-items:center; gap:var(--space-1); padding:var(--space-2); }
#app-sidebar{ display:flex; align-items:center; gap:.2rem; }
#app-sidebar .sidebar-btn{ height:var(--ui-height); min-width:var(--ui-height); border-radius:10px; padding:0 var(--pad-x); }
#app-sidebar .sidebar-btn span{ display:none; }
@media (min-width:1600px){ #app-sidebar .sidebar-btn span{ display:inline; font-size:calc(var(--ui-font) * .95); } }

/* Focus states shared */
:where(button, .btn, .tab, .badge, .pill, input, select, textarea, .sidebar-btn):focus-visible{
  outline:none; box-shadow:var(--ring);
}

/* Reduce motion preference */
@media (prefers-reduced-motion: reduce){
  *, *::before, *::after{ transition:none !important; animation:none !important; }
}
/* ==== End Global System ==== */


/* ==== Quick Range Toolbar ==== */
#quick-range {
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: .5rem;
}
#quick-range .btn-range {
    padding: .4rem .75rem;
    border: 1px solid var(--border-color);
    background: var(--white-color);
    color: var(--dark-text);
    border-radius: 999px;
    font-size: .85rem;
    line-height: 1;
    cursor: pointer;
    user-select: none;
    box-shadow: var(--shadow);
    transition: background-color .2s, color .2s, border-color .2s, box-shadow .2s, transform .02s;
}
#quick-range .btn-range:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    box-shadow: var(--shadow-hover);
}
#quick-range .btn-range:active {
    transform: translateY(1px);
}
#quick-range .btn-range:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}
#quick-range .btn-range.active {
    background: var(--primary-color);
    color: var(--white-color);
    border-color: var(--primary-color);
}
/* ==== End Quick Range Toolbar ==== */

/* --- Patch: hide history search icon on focus or when input has text --- */
#history-modal .input-with-icon:focus-within .icon { display: none; }
#history-modal .input-with-icon:focus-within input { padding-left: 12px; }
#history-modal .input-with-icon.has-text .icon { display: none; }
#history-modal .input-with-icon.has-text input { padding-left: 12px; }
/* --- End patch --- */
</style>

<style id="history-summary-enhanced-css">
/* History summary card */
#history-product-count.summary-item {
  display: none;
  padding: 12px 14px;
  background: #f7fbff;
  border: 1px solid var(--border-color);
  border-left: 4px solid var(--primary-color);
  border-radius: 10px;
  margin: 0 0 10px 0;
}
#history-product-count .hs-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px 16px;
  align-items: center;
}
#history-product-count .hs-title {
  font-weight: 700;
  color: var(--dark-text);
}
#history-product-count .hs-meta {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
#history-product-count .chip {
  padding: 2px 8px;
  border: 1px solid var(--border-color);
  border-radius: 999px;
  font-size: 0.85em;
  background: white;
}
#history-product-count .hs-actions {
  text-align: right;
  display: flex;
  gap: 8px;
  align-items: center;
}
#history-product-count .hs-actions .link {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.9em;
  color: var(--primary-color);
  text-decoration: underline;
  padding: 4px 6px;
}
/* Row highlight for matches */
#history-table tr.product-match { background-color: #fff9e6; }
#history-table tr.product-match:hover { background-color: #fff3cc; }
#history-table .qty-badge {
  display: inline-block;
  min-width: 18px; text-align: center;
  border-radius: 6px; padding: 0 6px;
  border: 1px solid var(--border-color);
  font-size: 0.8em;
  margin-left: 6px;
}
</style>





<style>
/* === Cart-aligned utility bar: app-sidebar + auth-status (Oct 18, 2025) === */
/* Tokens */
:root{
  --cart-surface: var(--surface-2, #ffffff);
  --cart-border: var(--border, #e5e7eb);
  --cart-muted: var(--muted-foreground, #6b7280);
  --cart-radius: var(--radius, 12px);
  --ui-height: var(--ui-height, 40px);
  --ui-font: var(--ui-font, 14px);
  --ui-icon: var(--ui-icon, 16px);
}

/* Utility group matches cart cards */
.cart-tabs-container{ display:flex; align-items:center; }
.cart-utility{
  display:flex;
  align-items:center;
  gap:12px;
  margin-left:auto;
  padding:8px 10px;
  background: var(--cart-surface);
  border: 1px solid var(--cart-border);
  border-radius: var(--cart-radius);
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

/* Sidebar controls as cart chips */
#app-sidebar{
  display:flex;
  align-items:center;
  gap:8px;
  margin:0;
}
#app-sidebar .btn,
#app-sidebar [role="button"],
#app-sidebar button{
  height: calc(var(--ui-height) * 1.05);
  padding: 0 0.9rem;
  font-size: calc(var(--ui-font) * 1.05);
  line-height:1;
  border: 1px solid var(--cart-border);
  border-radius: calc(var(--cart-radius) - 4px);
  background: transparent;
}
#app-sidebar .btn:hover,
#app-sidebar [role="button"]:hover,
#app-sidebar button:hover{
  background: rgba(0,0,0,0.03);
}

/* Auth status as compact pill */
#auth-status{
  display:inline-flex;
  align-items:center;
  gap:6px;
  height: calc(var(--ui-height) * 0.9 * 1.05);
  padding: 0 0.6rem;
  border: 1px solid var(--cart-border);
  border-radius: 999px;
  font-size: calc(var(--ui-font) * 0.95 * 1.05);
  color: var(--cart-muted);
  background: #fff;
}
#auth-status .dot{
  width: calc(var(--ui-icon) * 0.38 * 1.05);
  height: calc(var(--ui-icon) * 0.38 * 1.05);
  border-radius:50%;
}

/* Spacing harmony with cart header */
.cart-header, .cart-tabs-container{
  gap: 12px;
}

/* Responsive */
@media (max-width: 640px){
  .cart-utility{
    width:100%;
    justify-content:space-between;
    gap:8px;
    padding:6px 8px;
  }
  #app-sidebar{
    flex-wrap:wrap;
    justify-content:flex-end;
  }
}
</style>


<style id="mobile-pro-overrides">
@supports (padding: max(0px)) {
  :root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
}
:root{ --vh: 1vh; }
@media (max-width: 640px){
  html, body { height: auto; overflow: auto; }
  body { font-size: 16px; padding-bottom: max(84px, var(--safe-bottom)); }
  .card { border-radius: 12px; }
  button, input, select { min-height: 44px; }
  .app-layout { display:block; }
  .search-column, .cart-column { min-height: auto; }
  #cart-items{ max-height: none; }
  .button-group-2{
    position: fixed;
    left: 8px; right: 8px;
    bottom: calc(8px + var(--safe-bottom));
    z-index: 1002;
    background: rgba(255,255,255,.98);
    -webkit-backdrop-filter: saturate(1.1) blur(6px);
    backdrop-filter: saturate(1.1) blur(6px);
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.12);
  }
  .totals-section{ padding-bottom: 6px; }
  .total-row{ font-size: 1rem; }
  #cart-total{ font-size: 1.6rem; }
  #cart-tabs{ scroll-snap-type: x mandatory; gap: .25rem; }
  #cart-tabs .tab-button{ scroll-snap-align: start; }
  .search-item{ padding: 14px 12px; }
  #cart-items li{ padding: 8px 10px; }
  .delete-item-btn{ width: 34px; height: 34px; }
  .cart-header-row{ position: sticky; top: calc(8px + var(--safe-top)); background:#fff; z-index: 5; }
  .modal-content{ width: 96vw !important; height: 92vh !important; border-radius: 12px; }
  .modal-body{ overscroll-behavior: contain; }
}
.modal-overlay{ overscroll-behavior: contain; }
</style>
<style type="text/css">
/* Professional sizing for history-product-count */
#history-product-count{font-size:.95rem;line-height:1.5;margin:0.5rem 0;}
#history-product-count .hs-title{font-size:1rem;font-weight:600;}
#history-product-count .chip{font-size:.85em;}
@media (min-width: 1200px){
  #history-product-count{font-size:1rem;}
  #history-product-count .hs-title{font-size:1.05rem;}
}
</style></head>
<body class="density-compact">

<div class="app-layout">
    <div class="search-column">
        <div class="card">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                ค้นหาสินค้า
            </h2>
            <div class="form-group">
                <input type="text" id="barcode-input" placeholder="ค้นหา... (เช่น: 1234.)" data-base-placeholder="ค้นหาสินค้า...">
            </div>
            <div id="main-search-area">
                <div id="sales-summary-section" style="display: none; margin-bottom: 1rem;">
                    <h3 id="summary-title" style="font-size: 1.2rem; margin-bottom: 1rem;">สรุปยอดขาย (วันนี้)</h3>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="label">ยอดขายรวม</div><div class="value" id="summary-total-sales">0.00</div></div>
                        <div class="summary-item"><div class="label">ส่วนลดรวม</div><div class="value" id="summary-total-discount" style="color: var(--warning-color);">0.00</div></div>
                        <div class="summary-item"><div class="label">ยอดขายสุทธิ</div><div class="value" id="summary-net-sales" style="color: var(--success-color);">0.00</div></div>
                        <div class="summary-item"><div class="label">กำไร</div><div class="value" id="summary-profit" style="color: #00aaff;">0.00</div></div>
                        <div class="summary-item"><div class="label">จำนวนบิล</div><div class="value" id="summary-bill-count">0</div></div>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>

            <div id="shortcut-hints">F2:บิลใหม่ | F3:ค้นหา | F5:ประวัติ | F8:จำนวน | F9:ชำระเงิน | F11:ส่วนลด | Del:ล้าง/ปิด</div>
        </div>
    </div>
    <div class="cart-column">
        <div class="card">
            <div class="cart-tabs-container">
                <div id="cart-tabs-wrapper">
                    <div id="cart-tabs"></div>
                    <button type="button" id="add-new-tab-btn" title="เพิ่มบิลใหม่ (F2)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
<div class="cart-utility" role="group" aria-label="Cart utilities"><aside id="app-sidebar">
                    <button class="sidebar-btn" data-view="history" title="ประวัติ (F5)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                        <span>ประวัติ</span>
                    </button>
                    <button class="sidebar-btn" data-view="settings" title="ตั้งค่า">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                        <span>ตั้งค่า</span>
                    </button>
                    <button class="sidebar-btn" data-view="logout" id="logout-btn" title="ออกจากระบบ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                          <polyline points="16 17 21 12 16 7"></polyline>
                          <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>ออกจากระบบ</span>
                    </button>
    
                </aside>
                
<div id="auth-status" class="auth-status-badge" aria-live="polite" title="สถานะผู้ใช้" role="status"><span class="dot"></span><span>ยังไม่ได้เข้าสู่ระบบ</span></div></div>
            </div>
            <div id="edit-status" style="display: none; padding: 10px; background-color: #fff3cd; color: #856404; border-radius: 4px; margin-bottom: 1rem; margin-top:1rem;"></div>
            <div class="cart-header-row">
                <span class="col-seq">#</span>
                <span class="col-name">สินค้า</span>
                <span class="col-qty">จำนวน</span>
                <span class="col-price col-right">ราคา/หน่วย</span>
                <span class="col-total col-right">รวม</span>
                <span class="col-delete">ลบ</span>
            </div>
            <ul id="cart-items"></ul>
            
            <div class="totals-section">
                <div class="totals-summary">
                    <div class="total-row"><label>ยอดรวม:</label><span id="cart-subtotal">0.00</span></div>
                    <div class="total-row"><label for="discount-input">ส่วนลด (บาท):</label><input type="number" id="discount-input" placeholder="0.00" step="any"></div>
                    <div class="total-row" style="font-size: 1.5em; color: var(--success-color);"><label>ยอดสุทธิ:</label><span id="cart-total">0.00</span></div>
                    <div class="button-group-2">
                         <button type="button" class="finish-sale">ชำระเงิน (F9)</button>
                         <button type="button" class="clear-cart">ล้างตะกร้า (Del)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="promotion-tooltip"></div>


<div id="login-modal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:420px">
    <div class="modal-header"><h3>เข้าสู่ระบบ</h3></div>
    <div class="modal-body">
      <label for="login-code">รหัสผู้ใช้</label>
      <input id="login-code">
    </div>
    <div class="modal-footer">
      <div class="button-group">
        <button id="login-submit-btn">เข้าสู่ระบบ</button>
      </div>
    </div>
  </div>
</div>


<div id="history-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-body" style="display: flex; flex-direction: column;"> <section class="card" style="height: 100%; box-shadow: none; border: none; padding: 0;"> <h2>ประวัติการขาย</h2> <div id="history-filter-section"> <div class="filter-group"> <label for="history-search-input">ค้นหาบิล / สินค้า</label> <div class="input-with-icon"> <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span> <input type="text" id="history-search-input" placeholder="     รหัสการขาย หรือชื่อสินค้า..."> </div> </div> <div class="filter-group"> <label for="start-date">ช่วงวันที่และเวลา</label> <div style="display: flex; gap: 0.5rem; align-items: center;"> <input type="date" id="start-date" title="วันที่เริ่มต้น"> <input type="time" id="start-time" title="เวลาเริ่มต้น" style="width: 110px;"> <span style="color: var(--secondary-color);">-</span> <input type="date" id="end-date" title="วันที่สิ้นสุด"> <input type="time" id="end-time" title="เวลาสิ้นสุด" style="width: 110px;"> </div> </div> <div class="filter-group"> <div style="display: flex; gap: 0.5rem;"> <button type="button" id="filter-history-btn" style="width: 100%;">ค้นหา</button> <button type="button" id="today-history-btn" style="background-color: var(--info-color); width: 100%;">วันนี้</button> </div> </div> </div> <div class="button-group" id="quick-range" role="group" aria-label="ตัวกรองช่วงเวลาแบบด่วน" style="flex-wrap: wrap; gap: .5rem; margin: .2rem 0 1rem 0;">
  <button type="button" class="btn-range" data-days="1" aria-label="1 วัน">1 วัน</button>
  <button type="button" class="btn-range" data-days="7" aria-label="1 สัปดาห์">1 สัปดาห์</button>
  <button type="button" class="btn-range" data-days="14" aria-label="2 สัปดาห์">2 สัปดาห์</button>
  <button type="button" class="btn-range" data-months="1" aria-label="1 เดือน">1 เดือน</button>
  <button type="button" class="btn-range" data-months="3" aria-label="3 เดือน">3 เดือน</button>
  <button type="button" class="btn-range" data-months="6" aria-label="6 เดือน">6 เดือน</button>
  <button type="button" class="btn-range" data-months="12" aria-label="1 ปี">1 ปี</button>
<div id="history-product-count" class="summary-item" style="margin:0 0 1rem 0; display:none; text-align:left;" aria-live="polite"></div>
</div>
<div class="button-group" style="justify-content: flex-start; margin-bottom: 1rem; margin-top:0;"> <button type="button" id="export-excel-btn">Export to Excel</button> <button type="button" id="clear-all-history-btn" class="clear-cart" style="flex-grow: 0; margin-left: auto;">ล้างประวัติทั้งหมด</button> </div> <div id="history-table-wrapper"> <table id="history-table"> <thead><tr><th>วันที่/เวลา</th><th>รหัสการขาย</th><th>รายการสินค้า (จำนวน)</th><th>ส่วนลด</th><th>ยอดรวมสุทธิ</th><th>การกระทำ</th></tr></thead> <tbody id="history-body"></tbody> </table> </div> </section> </div> <div class="modal-footer"> <button type="button" class="close-main-modal-btn" style="background-color: var(--secondary-color);">ปิด</button> </div> </div> </div>
<div id="settings-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-body"> <section class="card" style="height: 100%; box-shadow: none; border: none; padding: 0;"> <h2>การตั้งค่าและจัดการ</h2> <div class="button-group"> <button type="button" id="manage-products-btn" style="background-color: var(--info-color);"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> จัดการสินค้า </button> <button type="button" id="import-from-sheet-btn" style="background-color: var(--success-color);"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg> นำเข้า/อัปเดตจาก Google Sheet </button> <button type="button" id="receipt-settings-btn" style="background-color: var(--secondary-color);"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> ตั้งค่าใบเสร็จ </button> </div> <div style="margin-top: 1rem; display: flex; align-items: center;"> <input type="checkbox" id="auto-import-toggle" style="width: auto; margin-right: 0.5rem;" checked> <label for="auto-import-toggle">นำเข้าข้อมูลอัตโนมัติเมื่อมีการเปลี่ยนแปลง (ตรวจสอบทุก 5 นาที)</label> </div> </section> </div> <div class="modal-footer"> <button type="button" class="close-main-modal-btn" style="background-color: var(--secondary-color);">ปิด</button> </div> </div> </div>
<div id="receipt-settings-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"> <h3>ตั้งค่าข้อมูลใบเสร็จ</h3> </div> <div class="modal-body"> <div class="form-group"> <label for="receipt-store-name">ชื่อร้านค้า</label> <input type="text" id="receipt-store-name" placeholder="ระบุชื่อร้านค้าของคุณ"> </div> <div class="form-group"> <label for="receipt-address">ที่อยู่</label> <input type="text" id="receipt-address" placeholder="เช่น 123/45 ถนน ABC, แขวง/ตำบล XYZ..."> </div> <div class="form-group"> <label for="receipt-phone">เบอร์โทรศัพท์</label> <input type="text" id="receipt-phone" placeholder="เช่น 02-123-4567"> </div> <div class="form-group"> <label for="receipt-tax-id">เลขประจำตัวผู้เสียภาษี</label> <input type="text" id="receipt-tax-id" placeholder="ระบุเลข 13 หลัก"> </div> </div> <div class="modal-footer"> <div class="button-group"> <button type="button" id="cancel-receipt-settings-btn" style="background-color:var(--secondary-color)">ยกเลิก</button> <button type="button" id="save-receipt-settings-btn" class="finish-sale">บันทึก</button> </div> </div> </div> </div>
<div id="payment-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"><h3>ชำระเงิน</h3></div> <div class="modal-body"> <div class="payment-modal-body"> <div class="payment-row"><span class="payment-label">ยอดสุทธิ</span><span class="payment-amount" id="payment-total-final">0.00</span></div> <div class="payment-row"><label for="cash-received-input" class="payment-label">รับเงินมา</label><input type="number" id="cash-received-input" step="any" placeholder="0.00"></div> <div class="payment-row"><span class="payment-label">เงินทอน</span><span class="payment-amount" id="payment-change">0.00</span></div> </div> </div> <div class="modal-footer"> <div class="button-group"> <button type="button" id="cancel-payment-btn" style="background-color:var(--secondary-color)">ยกเลิก (ESC)</button> <button type="button" id="confirm-sale-btn" class="finish-sale">ยืนยันการขาย (Enter)</button> </div> </div> </div> </div>
<div id="delete-confirm-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"><h3 style="color:var(--danger-color)">ยืนยันการลบ</h3></div> <div class="modal-body"><p id="delete-confirm-text"></p></div> <div class="modal-footer"> <div class="button-group"> <button type="button" id="cancel-delete-btn" style="background-color:var(--secondary-color)">ยกเลิก</button> <button type="button" id="confirm-delete-btn" class="clear-cart">ยืนยันการลบ</button> </div> </div> </div> </div>
<div id="clear-options-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"><h3>เลือกวิธีการล้างประวัติ</h3></div> <div class="modal-body"> <p>คุณต้องการล้างประวัติการขายแบบใด?</p> <div class="button-group" style="flex-direction: column; gap: 1rem;">
<button type="button" id="clear-local-btn" class="clear-cart" style="background-color: var(--info-color);">ล้างเฉพาะหน้าเว็บนี้</button> <button type="button" id="clear-db-btn" class="clear-cart">ล้างจากฐานข้อมูล (ถาวร)</button>
<button type="button" id="clear-range-local-btn" class="clear-cart" style="background-color: var(--info-color);">ล้างเฉพาะช่วงเวลาที่เลือก (เฉพาะหน้า)</button>
<button type="button" id="clear-range-db-btn" class="clear-cart" style="background-color: var(--danger-color);">ล้างเฉพาะช่วงเวลาที่เลือก (ฐานข้อมูล)</button>
</div> </div> <div class="modal-footer"> <button type="button" id="cancel-clear-btn" style="background-color: var(--secondary-color);">ยกเลิก</button> </div> </div> </div>
<div id="info-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"><h3 id="info-modal-title" style="color: var(--primary-color);"></h3></div> <div class="modal-body"><p id="info-modal-text"></p></div> <div class="modal-footer" style="justify-content:center"><button type="button" id="info-modal-ok-btn">ตกลง (Enter/ESC)</button></div> </div> </div>
<div id="product-mgmt-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-toolbar"> <h2>จัดการสินค้า</h2> <div class="input-with-icon" style="width: 300px;"> <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span> <input type="text" id="product-search-input" placeholder="ค้นหาสินค้า..."> </div> <button type="button" id="add-new-product-btn" class="finish-sale"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> เพิ่มสินค้าใหม่ </button> </div> <div id="product-list-container"></div> <div class="modal-footer"> <div id="product-list-pagination"></div> <button type="button" id="close-product-mgmt-btn" style="background-color: var(--secondary-color);">ปิด</button> </div> </div> </div>
<div id="product-editor-modal" class="modal-overlay"> <div class="modal-content"> <form id="product-editor-form"> <div class="modal-header"><h3 id="product-editor-title">เพิ่มสินค้าใหม่</h3></div> <div class="form-content-area"> <div class="form-column-left"> <h4 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">ข้อมูลสินค้าหลัก</h4> <div class="form-group"> <label for="product-code">รหัสสินค้า (ห้ามซ้ำ)</label> <input type="text" id="product-code" required> </div> <div class="form-group"> <label for="product-name">ชื่อสินค้า</label> <input type="text" id="product-name" required> </div> <div class="form-group"> <label for="product-category">หมวดหมู่ (ไม่บังคับ)</label> <input type="text" id="product-category"> </div> <div class="form-group"> <label for="product-base-unit">หน่วยเล็กที่สุด (สำหรับนับสต็อก)</label> <input type="text" id="product-base-unit" placeholder="เช่น ชิ้น, ขวด, กรัม" required> </div> <div class="form-group"> <label for="product-stock">จำนวนสต็อก (ตามหน่วยเล็กที่สุด)</label> <input type="number" id="product-stock" value="0" required>
<div class="form-group">
  <label style="display:flex; align-items:center; gap:.5rem;">
    <input type="checkbox" id="product-suspended" style="width:auto;">
    ระงับการขายสินค้านี้
  </label>
  <div class="sub-text" style="font-size:0.85em;color:var(--secondary-color);">
    เมื่อระงับ สินค้าจะไม่สามารถค้นหาและเพิ่มเข้าตะกร้าได้
  </div>
</div>
 </div> </div> <div class="form-column-right"> <h4 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">หน่วยและราคาขาย</h4> <div id="pricing-units-container"></div> <button type="button" id="add-pricing-unit-btn"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> เพิ่มหน่วยขาย </button> </div> </div> <div class="modal-footer"> <div class="button-group"> <button type="button" id="cancel-product-editor-btn" style="background-color: var(--secondary-color);">ยกเลิก</button> <button type="button" id="save-product-btn" class="finish-sale">บันทึกสินค้า</button> </div> </div> </form> </div> </div>

<script type="module">
    // Firebase Initialization (Secure Method with Local Fallback)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, getDocs, query, where, setDoc, updateDoc, collectionGroup, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let firebaseConfig;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
    } else {
        console.warn("Firebase config not found in environment. Using local fallback. PLEASE REPLACE PLACEHOLDER VALUES.");
        firebaseConfig = {
            apiKey: "AIzaSyB2KnaQuu4BovFI_VejlHTIV37f6RWL7WE",
            authDomain: "pos-08-47a44.firebaseapp.com",
            projectId: "pos-08-47a44",
            storageBucket: "pos-08-47a44.firebasestorage.app",
            messagingSenderId: "242962630777",
            appId: "1:242962630777:web:ad723fa72435554595aca8",
            measurementId: "G-4E7T8P5B9M"
        };
    }

    try {
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
            throw new Error("Firebase configuration is missing or contains placeholder values.");
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('error');

        window.firebaseServices = { db, auth, appId, api: { collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, getDocs, query, where, setDoc, updateDoc, collectionGroup, getDoc } };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Firebase Authenticated. User UID:", user.uid);
                window.dispatchEvent(new CustomEvent('firebase-ready'));
            } else {
                 console.log("No user is signed in. Attempting authentication...");
                 try {
                       if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                       } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                       }
                 } catch (authError) {
                       console.error("Firebase Authentication Failed:", authError);
                       window.dispatchEvent(new CustomEvent('firebase-failed', { detail: authError }));
                 }
            }
        });

    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        window.dispatchEvent(new CustomEvent('firebase-failed', { detail: error }));
    }
</script>
<script>

// [ADDED] Highlight ตามจำนวน
function updateCartHighlight(li, qty) {
    if (li) li.setAttribute("data-qty", qty);
}

const POS_APP = {
focusSearchIfReady() {
  
  try {
    // Skip when a modal/login popup is visible
    var hasModal = (function(){
      var sels = '[aria-modal="true"],[role="dialog"],.modal.show,.modal[style*="display: block"],.ui-dialog,.ant-modal,.swal2-container,.bootbox,.popup,.dialog,#login-modal,.login-modal,.login-overlay';
      var nodes = document.querySelectorAll(sels);
      for (var i=0;i<nodes.length;i++){
        var n = nodes[i], cs = window.getComputedStyle(n), r = n.getBoundingClientRect();
        if (cs && cs.display !== 'none' && cs.visibility !== 'hidden' && r.width > 0 && r.height > 0) return true;
      }
      var pwd = document.querySelector('input[type="password"]');
      if (pwd){
        var cs2 = window.getComputedStyle(pwd), r2 = pwd.getBoundingClientRect();
        if (cs2 && cs2.display !== 'none' && cs2.visibility !== 'hidden' && r2.width > 0 && r2.height > 0) return true;
      }
      return false;
    })();
    if (hasModal) return;
    // Focus the search box when ready
    var el = document.getElementById('barcode-input') 
          || document.querySelector('[data-role="search-barcode"], #search-input, input[name="barcode"], input[type="search"]');
    if (el && !el.disabled) {
      try { el.focus({preventScroll:true}); } catch(e){ el.focus(); }
      try { el.select && el.select(); } catch(e){}
    }
  } catch(e){}

},

updateAuthStatus(){
  const el = document.getElementById('auth-status');
  if(!el){ return; }
  if(!this.state || !this.state.isAuthenticated || !this.state.userRole){
    el.className = 'auth-status-badge offline';
    el.innerHTML = '<span class="dot"></span><span>ยังไม่ได้เข้าสู่ระบบ</span>';
    return;
  }
  const role = this.state.userRole === 'admin' ? 'Admin' : 'User';
  const name = this.state.currentUser ? ` (${this.state.currentUser})` : '';
  el.className = `auth-status-badge ${this.state.userRole}`;
  el.innerHTML = `<span class="dot"></span><span>${role}${name}</span>`;
},

    config: {
        googleSheetUrl: 'https://script.google.com/macros/s/AKfycbxmfug0KSRUqLMpDgb2LLbZRtdbOmj3P8gdmh1ZyL65aLB-wsmRQ6AJZRWSHdjGA3aZ/exec',
        thaiToEngMap: { 'ๅ': '1', '/': '2', '-': '3', 'ภ': '4', 'ถ': '5', 'ุ': '6', 'ึ': '7', 'ค': '8', 'ต': '9', 'จ': '0', 'ข': '-', 'ช': '=', 'ๆ': 'q', 'ไ': 'w', 'ำ': 'e', 'พ': 'r', 'ะ': 't', 'ั': 'y', 'ี': 'u', 'ร': 'i', 'น': 'o', 'ย': 'p', 'บ': '[', 'ล': ']', 'ฟ': 'a', 'ห': 's', 'ก': 'd', 'ด': 'f', 'เ': 'g', '้': 'h', '่': 'j', 'า': 'k', 'ส': 'l', 'ว': ';', 'ง': "'", 'ผ': 'z', 'ป': 
        'x', 'แ': 'c', 'อ': 'v', 'ิ': 'b', 'ท': 'n', 'ม': 'm', 'ใ': ',', 'ฝ': '.', 'ซ': '/' }
    },
    state: {
        activeOverlay: null,
        salesHistory: [],
        currentSearchResults: [],
        selectedSearchIndex: -1,
        unsubscribeSalesHistory: null,
        isSaving: false,
        activeModalCloseHandler: null,
        tabs: new Map(),
 
       activeTabId: null,
        isRestrictedMode: true,
        userRole: null,
        isAuthenticated: false,
        currentUser: null,
        keyboardLayout: 'ENG', 
        basePlaceholder: 'ค้นหา...',
        productsFromFirestore: [],
        searchableProductUnits: [],
        unsubscribeProducts: null,
        currentEditingProductId: null,
        lastSheetHash: null,
        autoImportInterval: null,
        _costCalculationListener: null,
 
       productListPage: 1,
        productsPerPage: 10,
        receiptSettings: {},
        lastInputTimestamp: 0,
        isScanning: false,
        scanResetTimer: null,
    },

    // [LOGIN] Modal helpers and auth
    showLoginModal() {
        const el = document.getElementById('login-modal');
        if (el) el.style.display = 'flex';
        this.setActiveOverlay('login');
        const input = document.getElementById('login-code');
        if (input) { input.value = ''; setTimeout(() => { input.focus(); }, 0); }
    },
    hideLoginModal() {
        const el = document.getElementById('login-modal');
        if (el) el.style.display = 'none';
        if (this.state.activeOverlay === 'login') this.setActiveOverlay(null);
    },
    handleLogin() {
        const input = document.getElementById('login-code');
        const code = (input && input.value || '').trim().toLowerCase();
        if (code === '111111') {
            this.state.userRole = 'admin';
            this.state.currentUser = 'admin';
            this.state.isAuthenticated = true;
            this.state.isRestrictedMode = false;
        } else if (code === 'pt01') {
            this.state.userRole = 'user';
            this.state.currentUser = 'pt01';
            this.state.isAuthenticated = true;
            this.state.isRestrictedMode = true;
        } else {
            this.showInfoModal('เข้าสู่ระบบล้มเหลว', 'รหัสไม่ถูกต้อง', true);
            return;
        }
        localStorage.setItem('pos_userRole', this.state.userRole);
        localStorage.setItem('pos_currentUser', this.state.currentUser);
        this.hideLoginModal();
        this.toggleUIVisibility();
    this.updateAuthStatus();
        this.updateHistoryDisplay?.();
    },
    logout() {
        localStorage.removeItem('pos_userRole');
        localStorage.removeItem('pos_currentUser');
        this.state.userRole = null;
        this.state.currentUser = null;
        this.state.isAuthenticated = false;
        this.state.isRestrictedMode = true;
        this.showLoginModal();
        this.toggleUIVisibility();
    this.updateAuthStatus();
        this.updateHistoryDisplay?.();
    },

    renderCartItemElement(item) {
        const li = document.createElement('li');
        li.classList.add('cart-item-row');
        li.innerHTML = `
            <span class="col-seq"></span>
            <span class="col-name">${item.name}</span>
            <span class="col-qty">${item.qty}</span>
            <span class="col-price">${item.price}</span>
            <span class="col-total">${(item.qty * item.price).toFixed(2)}</span>
            <span class="col-delete"><button class="delete-item-btn">x</button></span>
        `;
        updateCartHighlight(li, item.qty);
        return li;
    },
    init() {
        window.addEventListener('firebase-ready', () => this.start());
        window.addEventListener('firebase-failed', (event) => {
            const errorMessage = event.detail?.message || "An unknown error occurred.";
            this.showInfoModal("ข้อผิดพลาดร้ายแรง", `ไม่สามารถเชื่อมต่อฐานข้อมูลได้: ${errorMessage}`, true);
        });
    },
    
    async start() {
        // [LOGIN] wire up events and restore session
        const __loginSubmit = document.getElementById('login-submit-btn');
        if (__loginSubmit) __loginSubmit.addEventListener('click', () => this.handleLogin());
        const __loginInput = document.getElementById('login-code');
        if (__loginInput) __loginInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.handleLogin(); });
        const __savedRole = localStorage.getItem('pos_userRole');
        const __savedUser = localStorage.getItem('pos_currentUser');
        if (__savedRole === 'admin' || __savedRole === 'user') {
            this.state.userRole = __savedRole;
            this.state.currentUser = __savedUser;
            this.state.isAuthenticated = true;
            this.state.isRestrictedMode = (__savedRole !== 'admin');
            this.hideLoginModal();
        } else {
            this.showLoginModal();
        }
    
        console.log("Initializing main application logic...");
        const barcodeInput = document.getElementById('barcode-input');
        if (barcodeInput) this.state.basePlaceholder = barcodeInput.getAttribute('data-base-placeholder');
        this.updatePlaceholderHint();
        this.clearDataOnStart();
        await this.loadReceiptSettings();
        this.filterHistoryForToday();
        if (this.state.tabs.size === 0) this.addNewSaleTab();
        this.listenForProducts();
        this.setupEventListeners();
        this.toggleUIVisibility();
    this.updateAuthStatus(); 
        this.setActiveOverlay(null);
        this.focusSearchIfReady();
        this.startAutoImportPolling();
    },

    setActiveOverlay(overlayName) {
        this.state.activeOverlay = overlayName;
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === overlayName);
        });
        if (!overlayName) {
            this.focusSearchIfReady();
        }
    },

    showHistoryModal() {
        document.getElementById('history-modal').style.display = 'flex';
        this.setActiveOverlay('history');
    },
    hideHistoryModal() {
        document.getElementById('history-modal').style.display = 'none';
        this.setActiveOverlay(null);
    },
    showSettingsModal() {
        document.getElementById('settings-modal').style.display = 'flex';
        this.setActiveOverlay('settings');
    },
    hideSettingsModal() {
        document.getElementById('settings-modal').style.display = 'none';
        this.setActiveOverlay(null);
    },
    
    setupEventListeners() {
        // ✅ [MODIFIED] เพิ่ม Event Listener สำหรับ `pos:online`
        document.addEventListener('pos:online', () => this.syncOfflineSales());

        document.getElementById('app-sidebar').addEventListener('click', (e) => {
            const button = e.target.closest('.sidebar-btn');
            if (!button) return;
            const view = button.dataset.view;
            if (view === 'history') this.showHistoryModal();
            else if (view === 'settings') this.showSettingsModal();
   
                     else if (view === 'logout') this.logout();
});

        // [NEW] Event listener for the "Add Tab" button
        document.getElementById('add-new-tab-btn').addEventListener('click', () => this.addNewSaleTab());
        document.querySelectorAll('.close-main-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.hideHistoryModal();
                this.hideSettingsModal();
            });
        });
        document.getElementById('receipt-settings-btn').addEventListener('click', this.showReceiptSettingsModal.bind(this));
        document.getElementById('save-receipt-settings-btn').addEventListener('click', this.saveReceiptSettings.bind(this));
        document.getElementById('cancel-receipt-settings-btn').addEventListener('click', this.hideReceiptSettingsModal.bind(this));

        document.getElementById('import-from-sheet-btn').addEventListener('click', () => this.importFromGoogleSheet(false));
        const barcodeInput = document.getElementById('barcode-input');
        barcodeInput.addEventListener('input', this.handleInstantSearch.bind(this));
        document.getElementById('cart-items').addEventListener('mouseleave', this.hidePromotionTooltip.bind(this));
        barcodeInput.addEventListener('keydown', this.handleSearchKeyDown.bind(this));
        barcodeInput.addEventListener('keydown', this.detectKeyboardLayout.bind(this));
        barcodeInput.addEventListener('keydown', this.detectScan.bind(this));
        
        document.getElementById('discount-input').addEventListener('input', this.updateCartOnInput.bind(this));
        document.getElementById('discount-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.showPaymentModal(); }});
        document.querySelector('.finish-sale').addEventListener('click', this.showPaymentModal.bind(this));
        document.querySelector('.clear-cart').addEventListener('click', this.showClearCartConfirmModal.bind(this));
        document.getElementById('filter-history-btn').addEventListener('click', this.filterHistoryByDateTime.bind(this));
        document.getElementById('today-history-btn').addEventListener('click', this.filterHistoryForToday.bind(this));

        // Quick range shortcuts
        const quickRange = document.getElementById('quick-range');
        if (quickRange) {
            quickRange.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-days],button[data-months]');
                if (!btn) return;
                const now = new Date();
                // End at end of today
                const end = new Date(now);
                end.setHours(23, 59, 59, 999);
                // Start at start of the target day
                const start = new Date(now);
                const months = btn.dataset.months ? parseInt(btn.dataset.months, 10) : 0;
                const daysRaw = btn.dataset.days ? parseInt(btn.dataset.days, 10) : 0;

                if (months) {
                    const target = new Date(now);
                    target.setMonth(target.getMonth() - months);
                    start.setFullYear(target.getFullYear(), target.getMonth(), target.getDate());
                } else if (daysRaw) {
                    // Inclusive: 1 วัน = วันนี้เท่านั้น, 7 วัน = วันนี้ + ย้อนหลัง 6 วัน
                    const days = Math.max(1, daysRaw);
                    start.setDate(start.getDate() - (days - 1));
                }
                start.setHours(0, 0, 0, 0);

                // Active state
                quickRange.querySelectorAll('.btn-range').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Fill inputs
                const sd = document.getElementById('start-date');
                const ed = document.getElementById('end-date');
                const st = document.getElementById('start-time');
                const et = document.getElementById('end-time');
                if (sd && ed && st && et) {
                    sd.valueAsDate = start;
                    ed.valueAsDate = end;
                    st.value = '00:00';
                    et.value = '23:59';
                }
                this.filterHistoryByDateTime();
            });
        }

        
        const historySearchInput = document.getElementById('history-search-input');
        historySearchInput.addEventListener('keyup', (e) => {
            this.updateHistoryDisplay();
        });
        document.getElementById('export-excel-btn').addEventListener('click', this.exportToExcel.bind(this));
        document.getElementById('clear-all-history-btn').addEventListener('click', this.showClearOptionsModal.bind(this));
        document.getElementById('cash-received-input').addEventListener('input', this.calculateChange.bind(this));
        document.getElementById('cash-received-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.calculateChange(); document.getElementById('confirm-sale-btn').focus(); }});
        document.getElementById('confirm-sale-btn').addEventListener('click', this.confirmSale.bind(this));
        document.getElementById('cancel-payment-btn').addEventListener('click', this.hidePaymentModal.bind(this));
        document.getElementById('cancel-delete-btn').addEventListener('click', this.hideDeleteConfirmModal.bind(this));
        document.getElementById('clear-local-btn').addEventListener('click', this.clearHistoryLocally.bind(this));
        document.getElementById('clear-db-btn').addEventListener('click', this.executeClearAllHistory.bind(this));
        document.getElementById('cancel-clear-btn').addEventListener('click', this.hideClearOptionsModal.bind(this));
        const _crl = document.getElementById('clear-range-local-btn');
if (_crl) _crl.addEventListener('click', (ev) => {
  const app = window.POS_APP || this;
  if (app && typeof app.clearHistoryLocallyByRange === 'function') {
    app.clearHistoryLocallyByRange.call(app, ev);
  } else {
    console.warn('clearHistoryLocallyByRange is not available');
  }
});
const _crd = document.getElementById('clear-range-db-btn');
if (_crd) _crd.addEventListener('click', (ev) => {
  const app = window.POS_APP || this;
  if (app && typeof app.executeClearHistoryByRange === 'function') {
    app.executeClearHistoryByRange.call(app, ev);
  } else {
    console.warn('executeClearHistoryByRange is not available');
  }
});
document.getElementById('info-modal-ok-btn').addEventListener('click', this.hideInfoModal.bind(this));
        document.addEventListener('keydown', this.handleGlobalKeyDown.bind(this));
        document.getElementById('manage-products-btn').addEventListener('click', this.showProductMgmtModal.bind(this));
        document.getElementById('close-product-mgmt-btn').addEventListener('click', this.hideProductMgmtModal.bind(this));
        document.getElementById('add-new-product-btn').addEventListener('click', () => this.showProductEditorModal());
        document.getElementById('save-product-btn').addEventListener('click', this.handleSaveProduct.bind(this));
        document.getElementById('cancel-product-editor-btn').addEventListener('click', this.hideProductEditorModal.bind(this));
        document.getElementById('add-pricing-unit-btn').addEventListener('click', this.handleAddPricingUnit.bind(this));
        document.getElementById('product-list-container').addEventListener('click', this.handleProductListActions.bind(this));
        document.getElementById('product-editor-modal').addEventListener('click', this.handlePricingUnitActions.bind(this));
        document.getElementById('product-search-input').addEventListener('input', (e) => {
            this.state.productListPage = 1;
            this.renderProductList(e.target.value);
        });
        document.getElementById('auto-import-toggle').addEventListener('change', (e) => {
            if (e.target.checked) this.startAutoImportPolling();
            else this.stopAutoImportPolling();
        });
        document.getElementById('product-editor-form').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') e.preventDefault();
        });
        document.getElementById('confirm-sale-btn').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); this.confirmSale(); }
        });
        document.getElementById('product-list-pagination').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.page) {
                const newPage = parseInt(button.dataset.page, 10);
                if (newPage !== this.state.productListPage) {
                    this.state.productListPage = newPage;
    
                    this.renderProductList(document.getElementById('product-search-input').value);
                }
            }
        });
    },
    
    clearDataOnStart() {
        this.state.salesHistory = [];
        this.state.tabs = new Map();
        this.state.activeTabId = null;
        if (this.state.unsubscribeSalesHistory) this.state.unsubscribeSalesHistory();
        this.updateHistoryDisplay();
        this.renderTabs();
        const cartItemsEl = document.getElementById('cart-items');
        if (cartItemsEl) cartItemsEl.innerHTML = '';
        this.updateCartDisplay();
    },

    async _hashText(text) {
        if (!text) return 0;
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
            const char = text.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return hash;
    },

    async _normalizeAndHashData(jsonData) {
        if (!jsonData || !Array.isArray(jsonData)) {
            return 0;
        }
        const normalizedArray = jsonData.map(item => {
            const orderedItem = {};
            Object.keys(item).sort().forEach(key => {
                orderedItem[key] = item[key];
            });
            return orderedItem;
        });
        const stableString = JSON.stringify(normalizedArray);
        return this._hashText(stableString);
    },

    async startAutoImportPolling() {
        if (this.state.autoImportInterval) {
            clearInterval(this.state.autoImportInterval);
        }
        const intervalMinutes = 5;
        this.state.autoImportInterval = setInterval(async () => {
            console.log('Auto-Import: Checking for Google Script updates...');
            try {
                const response = await fetch(this.config.googleSheetUrl);
                if (!response.ok) return;

                const jsonData = await response.json();
       
                 const currentHash = await this._normalizeAndHashData(jsonData);

                if (this.state.lastSheetHash && this.state.lastSheetHash !== currentHash) {
                    console.log('Auto-Import: Detected changes. Importing...');
                    this.showInfoModal('อัปเดตอัตโนมัติ', 'ตรวจพบการเปลี่ยนแปลงใน Google Script กำลังนำเข้าข้อมูล...');
                  
                  this.importFromGoogleSheet(true);
                } else if (!this.state.lastSheetHash) {
                    console.log('Auto-Import: Initial hash set.');
                } else {
                    console.log('Auto-Import: No changes detected.');
              
                  }
                this.state.lastSheetHash = currentHash;
        } catch (error) {
                console.error('Auto-Import Error:', error);
        }
        }, intervalMinutes * 60 * 1000);
        (async () => {
            try {
                const response = await fetch(this.config.googleSheetUrl);
                if (response.ok) {
                    const jsonData = await response.json();
                    this.state.lastSheetHash = 
                    await this._normalizeAndHashData(jsonData);
                    console.log('Auto-Import: Polling started. Initial hash captured.');
                }
            } catch (e) {
                console.error('Auto-Import initial fetch error:', e);
            }
        })();
    },

    stopAutoImportPolling() {
        if (this.state.autoImportInterval) {
            clearInterval(this.state.autoImportInterval);
            this.state.autoImportInterval = null;
            console.log('Auto-Import: Polling stopped.');
        }
    },

    async importFromGoogleSheet(isAutomatic = false) {
        if (!isAutomatic && !confirm('คุณต้องการนำเข้าข้อมูลจาก Google Script หรือไม่?\n\nการกระทำนี้จะใช้ "รหัสสินค้า" ในการค้นหา:\n- "อัปเดต" สินค้าที่มีรหัสตรงกัน\n- "เพิ่ม" สินค้าใหม่ที่ยังไม่มีในระบบ\n(ข้อมูลราคาขายที่ซับซ้อนของเดิมจะไม่ถูกลบ)')) {
            return;
        }
        this.showInfoModal("กำลังนำเข้า...", "กำลังดาวน์โหลดข้อมูลจาก Google Script กรุณารอสักครู่...");
        try {
            const response = await fetch(this.config.googleSheetUrl);
            if (!response.ok) {
                throw new Error(`Network response was not ok, status: ${response.status}`);
            }
            const results = await response.json();
            const sheetData = results.data || results;

            if (!sheetData || !Array.isArray(sheetData) || sheetData.length === 0) {
                this.showInfoModal("ผิดพลาด", "ไม่พบข้อมูลจาก Google Script หรือข้อมูลที่ได้รับมีรูปแบบไม่ถูกต้อง", true);
                return;
            }

            const { db, api } = window.firebaseServices;
            const productsCollectionRef = this.getProductsCollectionRef();
            this.showInfoModal("กำลังประมวลผล...", "กำลังตรวจสอบข้อมูลสินค้าเดิมในระบบ...");
            
            const existingProducts = new Map();
            const snapshot = await api.getDocs(productsCollectionRef);
            snapshot.forEach(doc => {
                const product = doc.data();
                if (product.productCode) {
                    existingProducts.set(String(product.productCode), { id: doc.id, data: product });
                }
            });
            this.showInfoModal("กำลังประมวลผล...", `พบข้อมูล ${sheetData.length} รายการ, กำลังเปรียบเทียบและอัปเดต...`);
            const batch = api.writeBatch(db);
            const now = new Date().toISOString();
            let updatedCount = 0;
            let addedCount = 0;

            for (const row of sheetData) {
                const productCode = row['รหัสสินค้า'] ?
                String(row['รหัสสินค้า']).trim() : '';
                if (!productCode) continue;

                const barcode = row['บาร์โค้ด'] ? String(row['บาร์โค้ด']).trim() : '';
                const existingProductInfo = existingProducts.get(productCode);
                if (existingProductInfo) {
                    const docRef = api.doc(db, productsCollectionRef.path, existingProductInfo.id);
                    const productData = existingProductInfo.data;
                    let unitFound = false;
                    
                    productData.pricingUnits = productData.pricingUnits.map(unit => {
                        if (unit.barcode === barcode) {
                            unitFound = true;
                            // [PATCH] Update cost only when unit exists
unit.cost = 
                            parseFloat(row['ต้นทุน']) || unit.cost || 0;
                            // [PATCH] Preserve existing defaultPrice on update
// unit.defaultPrice = parseFloat(row['ราคา']) || unit.defaultPrice || 0;// [PATCH] Preserve existing priceTiers on update
// 
                            // [PATCH] Preserve existing priceTiers on update
                        }
                        return unit;
                    });
                    if (!unitFound && barcode) {
                        const defaultPrice = parseFloat(row['ราคา']) ||
                        0;
                        productData.pricingUnits.push({
                            unitName: row['หน่วย'] ? String(row['หน่วย']).trim() : 'หน่วย',
                            barcode: barcode,
                            cost: parseFloat(row['ต้นทุน']) || 0,
      
                                                   conversionFactor: 1,
                            defaultPrice: defaultPrice,
                            priceTiers: [{ quantity: 1, price: defaultPrice }]
              
                         });
                    }
                    
                    batch.update(docRef, {
                        stockInBaseUnits: parseInt(row['คงเหลือ'], 10) || productData.stockInBaseUnits,
                        pricingUnits: productData.pricingUnits,
      
                                         updatedAt: now
                    });
                    updatedCount++;
                } else {
                    const productName = row['ชื่อการค้า'] ?
                    String(row['ชื่อการค้า']).trim() : '';
                    if (!productName) continue;
                    
                    const newDocRef = api.doc(productsCollectionRef);
                    const unitName = row['หน่วย'] ? String(row['หน่วย']).trim() : 'หน่วย';
                    const defaultPrice = parseFloat(row['ราคา']) || 0;
                    
                    const newProductData = {
                        productCode: productCode,
                        productName: productName,
                        category: row['หมวดหมู่'] ?
                        String(row['หมวดหมู่']).trim() : '',
                        baseUnit: unitName,
                        stockInBaseUnits: parseInt(row['คงเหลือ'], 10) ||
                        0,
                        pricingUnits: [{
                            unitName: unitName,
                            barcode: barcode,
                 
                           cost: parseFloat(row['ต้นทุน']) ||
                           0,
                            conversionFactor: 1,
                            defaultPrice: defaultPrice,
                            priceTiers: [{ quantity: 1, price: defaultPrice }]
        
                         }],
                        createdAt: now,
                        updatedAt: now
                    };
                    batch.set(newDocRef, newProductData);
                    addedCount++;
                }
            }

            await batch.commit();
            this.showInfoModal("สำเร็จ", `นำเข้าข้อมูลเรียบร้อยแล้ว\nอัปเดต ${updatedCount} รายการ, เพิ่มใหม่ ${addedCount} รายการ`);

        } catch (error) {
            console.error("Error importing from Google Script:", error);
            this.showInfoModal("ผิดพลาด", `ไม่สามารถโหลดข้อมูลจาก Google Script ได้: ${error.message}`, true);
        }
    },

    getSalesHistoryCollectionRef() { const { appId, db, api } = window.firebaseServices;
    return api.collection(db, `artifacts/${appId}/public/data/salesHistory`); },
    getProductsCollectionRef() { const { appId, db, api } = window.firebaseServices; return api.collection(db, `artifacts/${appId}/public/data/products`);
    },
    getReceiptSettingsDocRef() { const { appId, db, api } = window.firebaseServices; return api.doc(db, `artifacts/${appId}/public/data/configuration/receipt`);
    },
    listenForProducts() { 
        const productsCollectionRef = this.getProductsCollectionRef();
        if (!productsCollectionRef) return; 
        if (this.state.unsubscribeProducts) this.state.unsubscribeProducts(); 
        this.state.unsubscribeProducts = window.firebaseServices.api.onSnapshot(productsCollectionRef, (querySnapshot) => { 
            const products = []; 
            querySnapshot.forEach(doc => { products.push({ id: doc.id, ...doc.data() }); }); 
            this.state.productsFromFirestore = products.sort((a, b) => (a.productName || '').localeCompare(b.productName || '')); 
            this.prepareSearchableProducts(); 
            this.renderProductList(); 
   
             }, (error) => { 
            console.error("Error listening for products:", error); 
            this.showInfoModal("ข้อผิดพลาด", "ไม่สามารถโหลดรายการสินค้าจากฐานข้อมูลได้", true); 
        });
    },
    calculateItemTotal(pricingUnit, quantity) {
        if (!pricingUnit) return 0;
        if (!pricingUnit.priceTiers || pricingUnit.priceTiers.length === 0) {
            return (pricingUnit.defaultPrice || 0) * quantity;
        }

        const sortedTiers = [...pricingUnit.priceTiers].sort((a, b) => b.quantity - a.quantity);
        let totalPrice = 0;
        let remainingQuantity = quantity;

        for (const tier of sortedTiers) {
            if (tier.quantity <= 0) continue;
            if (remainingQuantity >= tier.quantity) {
                const numBundles = Math.floor(remainingQuantity / tier.quantity);
                totalPrice += numBundles * tier.price;
                remainingQuantity %= tier.quantity;
            }
        }
        return totalPrice;
    },
    prepareSearchableProducts() {
        const flatList = [];
        this.state.productsFromFirestore.forEach(product => {
            const isSuspended = !!product.suspended;
            if (product.pricingUnits && Array.isArray(product.pricingUnits)) {
                product.pricingUnits.forEach(unit => {
                    if (isSuspended) { return; }
                    const basePrice = this.calculateItemTotal(unit, 1);
                    const cartItemId = unit.barcode || `${product.id}-${unit.unitName}`;
               
                    const searchableItem = {
                        productId: product.id,
                        productCode: product.productCode || '',
                        productName: product.productName,
                        suspended: isSuspended,
               
                         category: product.category || '',
                        baseUnit: product.baseUnit || '',
                        stockInBaseUnits: product.stockInBaseUnits || 0,
                        pricingUnit: unit,
         
                               display: `${product.productName} (${unit.unitName})`,
                        barcode: unit.barcode || '',
                        price: basePrice,
                        _searchableText: [product.productCode, product.productName, product.category, unit.unitName, unit.barcode].join(' ').toLowerCase().replace(/\s+/g, 
                        ' '),
                        cartItemId: cartItemId
                    };
                    flatList.push(searchableItem);
                });
            }
        });
        this.state.searchableProductUnits = flatList;
    },
    async handleSaveProduct(e) {
        e.preventDefault();
        this.state.isSaving = true;
        const productCode = document.getElementById('product-code').value.trim();
        const productName = document.getElementById('product-name').value.trim();
        if (!productCode || !productName) {
            this.showInfoModal("ข้อมูลไม่ครบ", "กรุณากรอกรหัสสินค้าและชื่อสินค้า", true);
            this.state.isSaving = false;
            return;
        }
        const pricingUnitCards = document.querySelectorAll('.pricing-unit-card');
        const pricingUnits = [];
        let formIsValid = true;
        pricingUnitCards.forEach(card => {
            const priceTierRows = card.querySelectorAll('.price-tier-row');
            let priceTiers = [];
            priceTierRows.forEach(row => {
                const quantity = parseInt(row.querySelector('input[data-field="tier-qty"]').value, 10);
                const price = parseFloat(row.querySelector('input[data-field="tier-price"]').value);
           
                 if (!isNaN(quantity) && quantity > 0 && !isNaN(price)) {
                    priceTiers.push({ quantity, price });
                } else {
                    formIsValid = false;
                }
        
             });
            if (priceTiers.length === 0) {
                formIsValid = false;
            }
            priceTiers.sort((a, b) => b.quantity - a.quantity);
            const defaultPrice = priceTiers.find(t => t.quantity === 1)?.price || priceTiers[priceTiers.length - 1]?.price || 0;
        
             const unit = {
                unitName: card.querySelector('input[data-field="unitName"]').value.trim(),
                barcode: card.querySelector('input[data-field="barcode"]').value.trim(),
                cost: parseFloat(card.querySelector('input[data-field="cost"]').value) ||
                0,
                conversionFactor: parseInt(card.querySelector('input[data-field="conversionFactor"]').value, 10) ||
                1,
                defaultPrice: defaultPrice,
                priceTiers: priceTiers
            };
            if (!unit.unitName) formIsValid = false;
            pricingUnits.push(unit);
        });
        if (!formIsValid) {
            this.showInfoModal("ข้อมูลไม่ถูกต้อง", "กรุณาตรวจสอบข้อมูลในหน่วยราคาขาย, ต้องมีอย่างน้อย 1 ระดับราคาที่ถูกต้อง", true);
            this.state.isSaving = false;
            return;
        }
        const productData = {
            productCode: productCode,
            productName: productName,
            category: document.getElementById('product-category').value.trim(),
            baseUnit: document.getElementById('product-base-unit').value.trim(),
            stockInBaseUnits: parseInt(document.getElementById('product-stock').value, 10) ||
            0,
            pricingUnits: pricingUnits,
            suspended: !!(document.getElementById('product-suspended') && document.getElementById('product-suspended').checked),
            updatedAt: new Date().toISOString()
        };
        try {
            const { api, db } = window.firebaseServices;
            if (this.state.currentEditingProductId) {
                const docRef = api.doc(db, this.getProductsCollectionRef().path, this.state.currentEditingProductId);
                await api.setDoc(docRef, productData, { merge: true });
            } else {
                productData.createdAt = new Date().toISOString();
                await api.addDoc(this.getProductsCollectionRef(), productData);
            }
            this.showInfoModal("สำเร็จ", "บันทึกข้อมูลสินค้าเรียบร้อยแล้ว");
            this.hideProductEditorModal();
        } catch (error) {
            console.error("Error saving product:", error);
            this.showInfoModal("ผิดพลาด", `เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`, true);
        } finally {
            this.state.isSaving = false;
        }
    },
    async handleDeleteProduct(productId) { 
        const productToDelete = this.state.productsFromFirestore.find(p => p.id === productId);
        if (!productToDelete) return; 
        const confirmation = confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบสินค้า "${productToDelete.productName}"? การกระทำนี้ไม่สามารถย้อนกลับได้`); 
        if (confirmation) { 
            try { 
                const { api, db } = window.firebaseServices;
                const docRef = api.doc(db, this.getProductsCollectionRef().path, productId); 
                await api.deleteDoc(docRef); 
                this.showInfoModal("สำเร็จ", `ลบสินค้า "${productToDelete.productName}" เรียบร้อยแล้ว`);
            } catch (error) { 
                console.error("Error deleting product:", error);
                this.showInfoModal("ผิดพลาด", `เกิดข้อผิดพลาดในการลบข้อมูล: ${error.message}`, true); 
            } 
        } 
    },
    showProductMgmtModal() { 
        document.getElementById('product-mgmt-modal').style.display = 'flex';
        document.getElementById('product-search-input').value = ''; 
        this.state.productListPage = 1;
        this.renderProductList(); 
    },
    hideProductMgmtModal() { document.getElementById('product-mgmt-modal').style.display = 'none';
    },
    showProductEditorModal(product = null) {
        this.state.currentEditingProductId = product ?
        product.id : null;
        const form = document.getElementById('product-editor-form');
        form.reset();
        document.getElementById('product-editor-title').textContent = product ? `แก้ไขสินค้า: ${product.productName}` : 'เพิ่มสินค้าใหม่';
        const unitsContainer = document.getElementById('pricing-units-container');
        unitsContainer.innerHTML = '';
        const productCodeInput = document.getElementById('product-code');
        productCodeInput.disabled = !!product;
        if (product) {
            productCodeInput.value = product.productCode || '';
            document.getElementById('product-name').value = product.productName || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-base-unit').value = product.baseUnit || '';
            document.getElementById('product-stock').value = product.stockInBaseUnits || 0;
            const suspendedEl = document.getElementById('product-suspended'); if (suspendedEl) suspendedEl.checked = !!product.suspended;
            (product.pricingUnits || []).forEach(unit => this.addPricingUnitRow(unit));
        } else {
            this.addPricingUnitRow();
            const suspendedEl = document.getElementById('product-suspended'); if (suspendedEl) suspendedEl.checked = false;
        }
        document.getElementById('product-editor-modal').style.display = 'flex';
        const container = document.getElementById('pricing-units-container');
        if (this.state._costCalculationListener) {
            container.removeEventListener('input', this.state._costCalculationListener);
        }
        this.state._costCalculationListener = (e) => {
            const target = e.target;
            if (!target.matches('input[data-field="cost"], input[data-field="conversionFactor"]')) {
                return;
            }
            const firstCard = container.querySelector('.pricing-unit-card:first-child');
            if (!firstCard) return;
            const firstCostInput = firstCard.querySelector('input[data-field="cost"]');
            const baseCost = parseFloat(firstCostInput.value) || 0;
            const changedCard = target.closest('.pricing-unit-card');
            if (changedCard === firstCard && target.dataset.field === 'cost') {
                const allOtherCards = container.querySelectorAll('.pricing-unit-card:not(:first-child)');
                allOtherCards.forEach(card => {
                    const conversionInput = card.querySelector('input[data-field="conversionFactor"]');
                    const costInput = card.querySelector('input[data-field="cost"]');
                    if (conversionInput && costInput) {
                        const factor = parseFloat(conversionInput.value) 
                        || 0;
                        costInput.value = (baseCost * factor).toFixed(2);
                    }
                });
            } 
            else if (changedCard !== firstCard && target.dataset.field === 'conversionFactor') {
                const costInput = changedCard.querySelector('input[data-field="cost"]');
                if (costInput) {
                    const factor = parseFloat(target.value) ||
                    0;
                    costInput.value = (baseCost * factor).toFixed(2);
                }
            }
        };
        container.addEventListener('input', this.state._costCalculationListener);
    },
    hideProductEditorModal() { document.getElementById('product-editor-modal').style.display = 'none';
    },
    renderProductList(filterText = '') {
        const container = document.getElementById('product-list-container');
        const lowercasedFilter = filterText.toLowerCase().trim();
        let productsToRender = this.state.productsFromFirestore;
        if (lowercasedFilter) {
            productsToRender = this.state.productsFromFirestore.filter(p => 
                (p.productName && p.productName.toLowerCase().includes(lowercasedFilter)) ||
                (p.productCode && p.productCode.toLowerCase().includes(lowercasedFilter)) ||
                (p.category && p.category.toLowerCase().includes(lowercasedFilter))
            );
        }
        const totalItems = productsToRender.length;
        const startIndex = (this.state.productListPage - 1) * this.state.productsPerPage;
        const endIndex = startIndex + this.state.productsPerPage;
        const paginatedItems = productsToRender.slice(startIndex, endIndex);
        if (totalItems === 0) {
             if (lowercasedFilter) {
                 container.innerHTML = '<p style="text-align:center; padding: 2rem;">ไม่พบสินค้าที่ตรงกับคำค้นหา</p>';
        } else {
                 container.innerHTML = '<p style="text-align:center; padding: 2rem;">ยังไม่มีสินค้าในระบบ, กด "เพิ่มสินค้าใหม่" หรือ "นำเข้าข้อมูล" เพื่อเริ่มต้น</p>';
        }
             this.renderPaginationControls(0);
             return;
        }
        const headerHTML = `<div class="product-list-row product-list-header"><span>ชื่อสินค้า (รหัส)</span><span>สต็อก</span><span>หน่วยราคา</span><span>การกระทำ</span></div>`;
        const rowsHTML = paginatedItems.map(p => `<div class="product-list-row"><div><strong>${p.productName}</strong><div class="sub-text">${p.productCode || ''}</div><div class="sub-text">${p.category || 'ไม่มีหมวดหมู่'}</div></div><div class="sub-text">${p.stockInBaseUnits} ${p.baseUnit}</div><div class="sub-text">${(p.pricingUnits || []).map(u => `${u.unitName} (${this.calculateItemTotal(u, 1)}฿)`).join(', ')}</div><div><button type="button" class="edit-history-btn" data-action="edit" data-id="${p.id}">แก้ไข</button><button type="button" class="delete-history-btn" data-action="delete" data-id="${p.id}">ลบ</button></div></div>`).join('');
        container.innerHTML = headerHTML + rowsHTML;
        this.renderPaginationControls(totalItems);
    },
    renderPaginationControls(totalItems) {
        const paginationContainer = document.getElementById('product-list-pagination');
        if (!paginationContainer) return;
        if (totalItems <= this.state.productsPerPage) {
            paginationContainer.innerHTML = '';
            return;
        }
        const totalPages = Math.ceil(totalItems / this.state.productsPerPage);
        const currentPage = this.state.productListPage;
        let html = '<div class="pagination-controls">';
        html += `<button data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>&laquo; ก่อนหน้า</button>`;
        html += `<span class="pagination-info">หน้า ${currentPage} / ${totalPages}</span>`;
        html += `<button data-page="${currentPage + 1}" ${currentPage === totalPages ?
        'disabled' : ''}>ถัดไป &raquo;</button>`;
        html += '</div>';
        paginationContainer.innerHTML = html;
    },
    addPricingUnitRow(unitData = null) {
        const container = document.getElementById('pricing-units-container');
        const card = document.createElement('div');
        card.className = 'pricing-unit-card';
        const priceTiers = (unitData && unitData.priceTiers && unitData.priceTiers.length > 0) ?
        unitData.priceTiers : [{ quantity: 1, price: 0 }];
        const priceTiersHTML = priceTiers.map(tier => this.createPriceTierRowHTML(tier.quantity, tier.price)).join('');
        card.innerHTML = `<div class="pricing-unit-header"><h4>หน่วยขาย</h4><button type="button" class="delete-item-btn" data-action="remove-unit" title="ลบหน่วยนี้"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></div><div class="pricing-unit-grid"><div class="form-group"><label>ชื่อหน่วย</label><input type="text" data-field="unitName" placeholder="เช่น ชิ้น, แพ็ค" value="${unitData?.unitName || ''}" required></div><div class="form-group"><label>บาร์โค้ด (ถ้ามี)</label><input type="text" data-field="barcode" value="${unitData?.barcode || ''}"></div><div class="form-group"><label>ต้นทุน/หน่วยนี้</label><input type="number" step="any" data-field="cost" value="${unitData?.cost ||
        0}"></div><div class="form-group"><label>ตัวคูณ (เทียบกับหน่วยเล็ก)</label><input type="number" step="1" data-field="conversionFactor" placeholder="1 แพ็ค = 6 ชิ้น (ใส่ 6)" value="${unitData?.conversionFactor || 1}" required></div></div><div class="price-tiers-container"><label style="font-weight:bold;
        font-size: 0.9em;">ราคาขายตามจำนวน</label><div class="price-tier-header"><div>ซื้อครบ (ชิ้น)</div><div>ราคารวม (บาท)</div><div></div></div><div class="price-tiers-list">${priceTiersHTML}</div><button type="button" class="add-tier-btn" data-action="add-tier">+ เพิ่มระดับราคา</button></div>`;
        container.appendChild(card);
    },
    createPriceTierRowHTML(quantity = 1, price = 0) {
        return `<div class="price-tier-row"><input type="number" class="item-input" data-field="tier-qty" value="${quantity}" min="1" required><input type="number" class="item-input" data-field="tier-price" value="${price}" min="0" step="any" required><button type="button" class="delete-item-btn" data-action="remove-tier" title="ลบระดับราคานี้"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>`;
    },
    handleAddPricingUnit() {
        const firstUnitCard = document.querySelector('#pricing-units-container .pricing-unit-card');
        let baseCost = 0;
        if (firstUnitCard) {
            const costInput = firstUnitCard.querySelector('input[data-field="cost"]');
            if (costInput) {
                baseCost = parseFloat(costInput.value) ||
                0;
            }
        }
        this.addPricingUnitRow({ cost: baseCost, conversionFactor: 1 });
    },
    handlePricingUnitActions(e) { 
        const button = e.target.closest('button');
        if (!button) return; 
        const action = button.dataset.action; 
        if (action === 'remove-unit') { 
            const card = button.closest('.pricing-unit-card');
            if (card.parentElement.children.length > 1) {
                card.remove();
            } else {
                alert('ต้องมีหน่วยขายอย่างน้อย 1 หน่วย');
            }
        } else if (action === 'add-tier') { 
            const list = button.previousElementSibling;
            list.insertAdjacentHTML('beforeend', this.createPriceTierRowHTML(1, 0)); 
        } else if (action === 'remove-tier') { 
            const row = button.closest('.price-tier-row');
            if (row.parentElement.children.length > 1) { 
                row.remove();
            } else { 
                alert('ต้องมีระดับราคาอย่างน้อย 1 ระดับ');
            } 
        } 
    },
    handleProductListActions(e) { 
        const target = e.target.closest('button');
        if (!target) return; 
        const action = target.dataset.action; 
        const id = target.dataset.id;
        if (action === 'edit') { 
            const productToEdit = this.state.productsFromFirestore.find(p => p.id === id);
            if (productToEdit) this.showProductEditorModal(productToEdit); 
        } else if (action === 'delete') { 
            this.handleDeleteProduct(id);
        } 
    },
    detectScan() {
        const now = Date.now();
        const timeDiff = now - this.state.lastInputTimestamp;
        this.state.lastInputTimestamp = now;

        if (timeDiff < 50) {
            this.state.isScanning = true;
        }

        clearTimeout(this.state.scanResetTimer);
        this.state.scanResetTimer = setTimeout(() => {
            this.state.isScanning = false;
        }, 100);
    },

    handleInstantSearch(e) {
        const query = e.target.value.trim();
        this.toggleUIVisibility();
        const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
        const match = query.match(quantityPattern);
        let effectiveQuery = match ? match[2].trim() : query;
        if (effectiveQuery.length < 1) {
            this.state.currentSearchResults = [];
            this.state.selectedSearchIndex = -1;
            this.displaySearchResults([], '');
            return;
        }

        let queryToSearch;
        if (this.state.isScanning) {
            queryToSearch = this.translateThaiToEng(effectiveQuery).toLowerCase();
        } else {
            queryToSearch = effectiveQuery.toLowerCase();
        }
        
        const results = this.state.searchableProductUnits.map(p => {
            let score = 0;
            const searchableText = p._searchableText;

            if (p.barcode && p.barcode.toLowerCase() === queryToSearch) {
                score = 100;
            } 
            else if (p.productCode && p.productCode.toLowerCase() === queryToSearch) {
                score = 80;
            } else if (searchableText.includes(queryToSearch)) {
                if (p.productName.toLowerCase().startsWith(queryToSearch)) {
                    score = 50;
                } else {
 
                                       score = 20;
                }
            }

            if (score > 0) {
                return { ...p, score };
            }
   
                 return null;
        }).filter(Boolean);
        results.sort((a, b) => {
            if (b.score !== a.score) { return b.score - a.score; }
            return a.productName.localeCompare(b.productName);
        });
        this.state.currentSearchResults = results;
        this.state.selectedSearchIndex = results.length > 0 ? 0 : -1;
        this.displaySearchResults(results, queryToSearch);
    },
    formatPrice(price) {
        const num = parseFloat(price);
        if (isNaN(num)) {
            return '0.-';
        }
        if (num % 1 === 0) {
            return `${num.toFixed(0)}.-`;
        } else {
            return num.toFixed(2);
        }
    },
    displaySearchResults(results, query) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        resultsContainer.classList.toggle('has-results', results.length > 0);
        if (results.length === 0) return;
        results.slice(0, 20).forEach((productUnit, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'search-item';
            if (index === this.state.selectedSearchIndex) itemDiv.classList.add('selected');
            let highlightedDisplay = this.escapeHtml(productUnit.display);
            
            itemDiv.innerHTML = `<div><span>${highlightedDisplay}</span></div><span class="price">${this.formatPrice(productUnit.price)}</span>`;
         
               
            itemDiv.onclick = () => {
                const inputValue = document.getElementById('barcode-input').value.trim();
                const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
                const match = inputValue.match(quantityPattern);
                let quantityToAdd = 1;
     
                           if (match) {
                    quantityToAdd = parseInt(match[1], 10);
                }
                this.addToCart(this.state.currentSearchResults[index], quantityToAdd);
                document.getElementById('barcode-input').value = '';
                this.state.currentSearchResults = [];
                this.state.selectedSearchIndex = -1;
                this.displaySearchResults([], '');
                this.toggleUIVisibility();
            };
            resultsContainer.appendChild(itemDiv);
        });
    },
    escapeRegex(string) { return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); },
    escapeHtml(string) { const p = document.createElement("p");
    p.textContent = string; return p.innerHTML; },
    addToCart(productUnit, quantityToAdd = 1) { 
        if (productUnit && (productUnit.suspended || (productUnit.product && productUnit.product.suspended))) { this.showInfoModal('ระงับการขาย', 'สินค้านี้ถูกระงับการขาย ไม่สามารถเพิ่มเข้าตะกร้าได้', true); return; }
        const cart = this.getActiveCart();
        if (!cart) return; 
        const cartItemId = productUnit.barcode || `${productUnit.productId}-${productUnit.pricingUnit.unitName}`; 
        const existingProduct = cart.find(item => item.cartItemId === cartItemId);
        if (existingProduct) { 
            existingProduct.quantity += quantityToAdd; 
            delete existingProduct.priceOverride;
        } else { 
            const newItem = { cartItemId: cartItemId, productUnit: productUnit, quantity: quantityToAdd };
            cart.push(newItem); 
        } 
        this.updateCartDisplay();
    },
    
    // [NEW] Functions to show and hide the promotion tooltip
    showPromotionTooltip(event) {
        const li = event.currentTarget;
        const tooltip = document.getElementById('promotion-tooltip');
        try {
            const promotions = JSON.parse(li.dataset.promotions);
            const productName = li.dataset.productName;

            if (!promotions || promotions.length === 0) return;

            let infoHtml = `<h4>โปรโมชั่นสำหรับ: ${this.escapeHtml(productName)}</h4><ul>`;
            promotions.forEach(tier => {
                infoHtml += `<li>ซื้อ <span class="highlight">${tier.quantity}</span> ชิ้น ราคา <span class="highlight">${tier.price}</span> บาท</li>`;
            });
            infoHtml += '</ul>';

            tooltip.innerHTML = infoHtml;
            tooltip.style.display = 'block';

            // Position the tooltip near the cursor, but prevent it from going off-screen
            const rect = li.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = event.clientY + 15;
            let left = event.clientX + 10;
            if (top + tooltipRect.height > window.innerHeight) {
                top = event.clientY - tooltipRect.height - 10;
            }
            if (left + tooltipRect.width > window.innerWidth) {
                left = event.clientX - tooltipRect.width - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        } catch (e) {
            console.error("Could not parse promotions data", e);
            tooltip.style.display = 'none';
        }
    },

    hidePromotionTooltip() {
        document.getElementById('promotion-tooltip').style.display = 'none';
    },


    updateCartDisplay() {
        const cart = this.getActiveCart();
        const discount = this.getActiveDiscount();
        document.getElementById('discount-input').value = discount || '';
        const cartItemsElement = document.getElementById('cart-items');
        cartItemsElement.innerHTML = '';
        if (!cart) return;
        let subtotal = 0;
        cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.dataset.cartItemId = item.cartItemId;

            const { productUnit, quantity, priceOverride } = item;
            let totalForItem;
            let pricePerUnit;

            if (typeof priceOverride === 'number') {
  
                             pricePerUnit = priceOverride;
                totalForItem = pricePerUnit * quantity;
            } else {
                totalForItem = this.calculateItemTotal(productUnit.pricingUnit, quantity);
                pricePerUnit = quantity > 0 ? totalForItem / quantity : 0;
     
               }
            subtotal += totalForItem;
            
            // [MODIFIED] Check for promotions and add listeners
            const promotions = productUnit?.pricingUnit?.priceTiers?.filter(tier => tier.quantity > 1);
            if (promotions && promotions.length > 0) {
           
                 li.classList.add('has-promotion');
                li.dataset.promotions = JSON.stringify(promotions);
                li.dataset.productName = productUnit.display;
                li.addEventListener('mouseenter', this.showPromotionTooltip.bind(this));
                li.addEventListener('mouseleave', this.hidePromotionTooltip.bind(this));
            }


            if (quantity > 1) {
                li.classList.add('highlight-quantity');
            }
            const stockInThisUnit = productUnit.stockInBaseUnits / productUnit.pricingUnit.conversionFactor;
            let itemInfoHTML = `<strong>${productUnit.display}</strong>`;
            if (!this.state.isRestrictedMode) {
                itemInfoHTML += ` <span class="sub-text">(คงเหลือ: ${stockInThisUnit.toFixed(2)} ${productUnit.pricingUnit.unitName})(ต้นทุน: ${(productUnit.pricingUnit.cost || 0).toFixed(2)})</span>`;
            }
            li.innerHTML = `<div class="col-seq">${index + 1}</div><div class="col-name">${itemInfoHTML}</div><div class="col-qty"><input type="number" class="item-input" value="${quantity}" onchange="POS_APP.editItemQuantity(${index}, this.value)" onfocus="this.select()" onkeydown="if(event.key === 'Enter') { event.preventDefault(); document.getElementById('discount-input').focus(); document.getElementById('discount-input').select(); }"></div><div class="col-price"><input type="text" class="item-input" value="${pricePerUnit.toFixed(2)}" disabled></div><div class="col-total"><input type="text" class="item-input" value="${totalForItem.toFixed(2)}" onchange="POS_APP.editItemTotal(${index}, this.value)" onfocus="this.select()"></div><div class="col-delete"><button type="button" class="delete-item-btn" onclick="POS_APP.deleteItemFromCart(${index})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></div>`;
            cartItemsElement.appendChild(li);
        });
        const total = subtotal - (discount || 0);
        document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('cart-total').textContent = total.toFixed(2);
    },

    editItemTotal(index, newTotalValue) {
        const cart = this.getActiveCart();
        const item = cart[index];
        if (!item) return;

        const newTotal = parseFloat(newTotalValue);
        if (!isNaN(newTotal) && newTotal >= 0 && item.quantity > 0) {
            item.priceOverride = newTotal / item.quantity;
        } else {
            delete item.priceOverride;
        }
        this.updateCartDisplay();
    },

    showInfoModal(title, text, isError = false) { 
        const titleEl = document.getElementById('info-modal-title');
        const textEl = document.getElementById('info-modal-text'); 
        const okBtn = document.getElementById('info-modal-ok-btn'); 
        titleEl.textContent = title; 
        titleEl.style.color = isError ? 'var(--danger-color)' : 'var(--primary-color)';
        textEl.textContent = text; 
        okBtn.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--primary-color)'; 
        document.getElementById('info-modal').style.display = 'flex';
        this.state.activeModalCloseHandler = (e) => { 
            if (e.key === 'Enter' || e.key === 'Escape') { 
                e.preventDefault();
                this.hideInfoModal(); 
            } 
        }; 
        document.addEventListener('keydown', this.state.activeModalCloseHandler); 
        okBtn.focus();
    },
    hideInfoModal() { 
        document.getElementById('info-modal').style.display = 'none';
        if (this.state.activeModalCloseHandler) { 
            document.removeEventListener('keydown', this.state.activeModalCloseHandler); 
            this.state.activeModalCloseHandler = null;
        } 
    },
    updatePlaceholderHint() { 
        const input = document.getElementById('barcode-input');
        if (input) input.placeholder = `[${this.state.keyboardLayout}] ${this.state.basePlaceholder}`; 
    },
    detectKeyboardLayout(e) { 
        if (e.key.length !== 1 || e.ctrlKey || e.altKey || e.metaKey) return;
        const isThai = /[ก-๙]/.test(e.key); 
        if (isThai && this.state.keyboardLayout !== 'TH') { 
            this.state.keyboardLayout = 'TH';
            this.updatePlaceholderHint(); 
        } else if (!isThai && this.state.keyboardLayout !== 'ENG') { 
            this.state.keyboardLayout = 'ENG';
            this.updatePlaceholderHint(); 
        } 
    },
    handleSearchKeyDown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const inputValue = document.getElementById('barcode-input').value.trim();
            
            const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
            const match = inputValue.match(quantityPattern);
            if (this.state.currentSearchResults.length > 0 && this.state.selectedSearchIndex !== -1) {
                let quantityToAdd = 1;
                if (match) {
                    quantityToAdd = parseInt(match[1], 10);
                }
                this.addToCart(this.state.currentSearchResults[this.state.selectedSearchIndex], quantityToAdd);
                document.getElementById('barcode-input').value = '';
                this.state.currentSearchResults = [];
                this.state.selectedSearchIndex = -1;
                this.displaySearchResults([], '');
                this.toggleUIVisibility();
            } else if (this.getActiveCart().length > 0 && inputValue === '') {
                document.getElementById('discount-input').focus();
                document.getElementById('discount-input').select();
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.navigateSearchResults(1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.navigateSearchResults(-1);
        }
    },
    handleGlobalKeyDown(e) { 
        if (this.state.activeModalCloseHandler) return;
        if (e.ctrlKey && (e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'ArrowLeft')) { 
            e.preventDefault();
            const direction = (e.shiftKey || e.key === 'ArrowLeft') ? -1 : 1; 
            this.navigateTabs(direction);
        } else if (e.ctrlKey && e.key === 'w') { 
            e.preventDefault();
            if(this.state.activeTabId) this.closeTab(this.state.activeTabId); 
        } else if (e.key === 'Delete') { 
            e.preventDefault();
            const cart = this.getActiveCart();
            if (cart && cart.length > 0) {
                this.showClearCartConfirmModal();
            } else if (this.state.activeTabId) {
                this.closeTab(this.state.activeTabId, true);
            }
        } else if (e.key === 'F9') { 
            e.preventDefault();
            this.showPaymentModal(); 
        } else if (e.key === 'F11') { 
            e.preventDefault();
            document.getElementById('discount-input').focus(); 
            document.getElementById('discount-input').select(); 
        } else if (e.key === 'F2') { 
            e.preventDefault();
            this.addNewSaleTab(); 
        } 
        else if (e.key === 'F3') { 
            e.preventDefault();
            this.focusSearchIfReady(); 
        } else if (e.key === 'F5') {
            e.preventDefault();
            this.showHistoryModal();
            const historySearchInput = document.getElementById('history-search-input');
            if (historySearchInput) {
                historySearchInput.focus();
                historySearchInput.select();
            }
        } 
        else if (e.key === 'F8') { 
            e.preventDefault();
            const cartItems = document.querySelectorAll('#cart-items li');
            if (cartItems.length > 0) {
                const lastItemInput = cartItems[cartItems.length - 1].querySelector('.col-qty input');
                if (lastItemInput) {
                    lastItemInput.focus();
                    lastItemInput.select();
                }
            }
        } else if (e.key === 'Escape') { 
            if(this.state.activeOverlay) {
                this.hideHistoryModal();
                this.hideSettingsModal();
                this.hideReceiptSettingsModal();
            } else if (document.getElementById('payment-modal').style.display === 'flex') { e.preventDefault(); this.hidePaymentModal();
            } 
            else if (document.getElementById('delete-confirm-modal').style.display === 'flex') { e.preventDefault();
            this.hideDeleteConfirmModal(); } 
            else if (document.getElementById('clear-options-modal').style.display === 'flex') { e.preventDefault();
            this.hideClearOptionsModal(); } 
            else if (document.getElementById('product-mgmt-modal').style.display === 'flex') { e.preventDefault();
            this.hideProductMgmtModal(); } 
            else if (document.getElementById('product-editor-modal').style.display === 'flex') { e.preventDefault();
            this.hideProductEditorModal(); } 
        } 
    },
    navigateSearchResults(direction) { 
        if (this.state.currentSearchResults.length === 0) return;
        this.state.selectedSearchIndex += direction; 
        if (this.state.selectedSearchIndex < 0) this.state.selectedSearchIndex = this.state.currentSearchResults.length - 1; 
        else if (this.state.selectedSearchIndex >= this.state.currentSearchResults.length) this.state.selectedSearchIndex = 0;
        this.updateSelectedSearchResult(); 
    },
    updateSelectedSearchResult() { 
        const items = document.querySelectorAll('.search-item');
        items.forEach((item, index) => { 
            if (index === this.state.selectedSearchIndex) { 
                item.classList.add('selected'); 
                item.scrollIntoView({ block: 'nearest' }); 
            } else { 
                item.classList.remove('selected'); 
          
             } 
        });
    },
    translateThaiToEng(input) { return input.split('').map(char => this.config.thaiToEngMap[char] || char).join('');
    },
    getActiveCart() { if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return []; return this.state.tabs.get(this.state.activeTabId).cart;
    },
    getActiveDiscount() { if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return 0; return this.state.tabs.get(this.state.activeTabId).discount;
    },
    setActiveDiscount(value) { if (this.state.activeTabId && this.state.tabs.has(this.state.activeTabId)) { this.state.tabs.get(this.state.activeTabId).discount = value;
    } },
    editItemQuantity(index, newQuantityString) { 
        const cart = this.getActiveCart();
        const newQuantity = parseInt(newQuantityString, 10); 
        if (isNaN(newQuantity) || newQuantity <= 0) { 
            cart.splice(index, 1);
        } else { 
            const item = cart[index];
            if (item) {
                item.quantity = newQuantity;
                delete item.priceOverride;
            }
        } 
        this.updateCartDisplay();
    },
    deleteItemFromCart(index) { const cart = this.getActiveCart(); cart.splice(index, 1); this.updateCartDisplay();
    },
    clearCart() { 
        const tabData = this.state.tabs.get(this.state.activeTabId);
        if (tabData && tabData.cart.length > 0) { 
            tabData.cart = [];
            tabData.discount = 0; 
            this.updateCartDisplay(); 
        } 
    },
    showClearCartConfirmModal() { 
        const cart = this.getActiveCart();
        if (cart.length === 0) return; 
        const confirmBtn = document.getElementById('confirm-delete-btn'); 
        const confirmText = document.getElementById('delete-confirm-text'); 
        confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการล้างตะกร้าสินค้าทั้งหมด?`;
        confirmBtn.onclick = () => { this.clearCart(); this.hideDeleteConfirmModal(); }; 
        document.getElementById('delete-confirm-modal').style.display = 'flex'; 
        confirmBtn.focus();
    },
    updateCartOnInput(){ 
        const discountValue = parseFloat(document.getElementById('discount-input').value) || 0; 
        this.setActiveDiscount(discountValue);
        this.updateCartDisplay(); 
    },
    showPaymentModal() { 
        const cart = this.getActiveCart();
        if (cart.length === 0) return; 
        const subtotal = parseFloat(document.getElementById('cart-subtotal').textContent); 
        const discount = this.getActiveDiscount(); 
        const finalTotal = subtotal - discount;
        document.getElementById('payment-total-final').textContent = finalTotal.toFixed(2); 
        document.getElementById('payment-change').textContent = "0.00"; 
        const cashInput = document.getElementById('cash-received-input'); 
        cashInput.value = ''; 
        document.getElementById('payment-modal').style.display = 'flex'; 
        cashInput.focus();
    },
    hidePaymentModal() { 
        document.getElementById('payment-modal').style.display = 'none'; 
        this.focusSearchIfReady();
    },
calculateChange() {
    const total = parseFloat(document.getElementById('payment-total-final').textContent);
    const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0;
    const change = cashReceived - total;
    const changeEl = document.getElementById('payment-change');
    
    if (change >= 0) {
        changeEl.textContent = change.toFixed(2);
        changeEl.style.color = 'var(--success-color)';
    } else {
        changeEl.textContent = 'เงินไม่พอ';
        changeEl.style.color = 'var(--danger-color)';
        // [REMOVED] ลบโค้ดส่วนที่ย้ายเคอร์เซอร์ออกจากฟังก์ชันนี้
    }
},

async confirmSale() {
    if (this.state.isSaving) return;

    const collectionRef = this.getSalesHistoryCollectionRef();
    if (!collectionRef && !window.OfflineQueue) {
        this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูลและไม่สามารถบันทึก Offline ได้", true);
        return;
    }

    const tabData = this.state.tabs.get(this.state.activeTabId);
    if (!tabData) return;
    const { cart, discount } = tabData;
    const subtotal = cart.reduce((sum, item) => {
        if (typeof item.priceOverride === 'number') {
            return sum + (item.priceOverride * item.quantity);
        }
        return sum + this.calculateItemTotal(item.productUnit.pricingUnit, item.quantity);
    }, 0);
    const finalTotal = subtotal - discount;
    const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0;
    
    // [MODIFIED] ตรวจสอบยอดเงินและย้ายเคอร์เซอร์ถ้าไม่พอ
    if (cashReceived < finalTotal) {
        // เรียกใช้ฟังก์ชัน calculateChange() เพื่อแสดงสถานะ "เงินไม่พอ"
        this.calculateChange();
        
        // ย้ายเคอร์เซอร์กลับไปที่ช่องรับเงิน
        const cashInput = document.getElementById('cash-received-input');
        cashInput.focus();
        cashInput.select();
        
        // หยุดการทำงานของฟังก์ชันทันที
        return; 
    }
    
    this.state.isSaving = true;
    const confirmButton = document.getElementById('confirm-sale-btn');
    confirmButton.disabled = true;
    
    const newSaleId = await this.generateSaleId();
    const saleRecordItems = cart.map(item => {
        const conversionFactor = item.productUnit?.pricingUnit?.conversionFactor || 1;
        const costPerSellingUnit = item.productUnit?.pricingUnit?.cost || 0;
        const costPerBaseUnit = conversionFactor > 0 ? costPerSellingUnit / conversionFactor : 0;
        const pricePerUnit = typeof item.priceOverride === 'number' 
            ? item.priceOverride 
            : this.calculateItemTotal(item.productUnit.pricingUnit, item.quantity) / item.quantity;
        return {
            cartItemId: item.cartItemId, name: item.productUnit.display, unit: item.productUnit.pricingUnit.unitName,
            quantity: item.quantity, price: pricePerUnit,
            cost: costPerSellingUnit, productName: item.productUnit.productName, baseUnit: item.productUnit.baseUnit,
            conversionFactor: conversionFactor, costPerBaseUnit: costPerBaseUnit,
            productId: item.productUnit.productId
        };
    });

    const saleRecord = {
        id: newSaleId, timestamp: new Date().toISOString(), items: saleRecordItems, subtotal: subtotal,
        discount: discount, total: finalTotal, cashReceived: cashReceived, change: cashReceived - finalTotal,
    };
    
    const { api, db } = window.firebaseServices;
    const productsCollectionRef = this.getProductsCollectionRef();
    const batch = api.writeBatch(db);
    
    for (const item of cart) {
        const productRef = api.doc(productsCollectionRef, item.productUnit.productId);
        const quantityInBaseUnits = item.quantity * (item.productUnit.pricingUnit.conversionFactor || 1);
        const currentStock = item.productUnit.stockInBaseUnits || 0;
        const newStock = currentStock - quantityInBaseUnits;
        batch.update(productRef, { stockInBaseUnits: newStock });
    }
    
    try {
        if (tabData.isEditing && tabData.originalFirestoreId) {
            const oldSaleRef = api.doc(db, collectionRef.path, tabData.originalFirestoreId);
            const newSaleRef = api.doc(collectionRef);
            batch.delete(oldSaleRef);
            batch.set(newSaleRef, saleRecord);
        } else {
            const newSaleDocRef = api.doc(collectionRef);
            batch.set(newSaleDocRef, saleRecord);
        }
        
        await batch.commit();

        this.hidePaymentModal();
        const tabToDelete = this.state.activeTabId;
        document.getElementById('edit-status').style.display = 'none';
        this.closeTab(tabToDelete, false);

    } catch (e) {
        console.error("Error committing sale, saving to offline queue: ", e);
        
        if(window.OfflineQueue) {
            window.OfflineQueue.push({
                type: 'sale',
                payload: saleRecord,
                tabData: {
                    isEditing: tabData.isEditing,
                    originalFirestoreId: tabData.originalFirestoreId
                }
            });
            this.showInfoModal("บันทึก Offline", "ไม่สามารถเชื่อมต่อฐานข้อมูลได้ บันทึกการขายนี้ไว้ในเครื่องแล้ว และจะส่งข้อมูลอีกครั้งเมื่อออนไลน์", false);
            
            this.hidePaymentModal();
            const tabToDelete = this.state.activeTabId;
            document.getElementById('edit-status').style.display = 'none';
            this.closeTab(tabToDelete, false);
        } else {
            this.showInfoModal("ผิดพลาด", "เกิดข้อผิดพลาดในการบันทึกข้อมูลการขายและอัปเดตสต็อก!", true);
        }
    } finally {
        this.state.isSaving = false;
        confirmButton.disabled = false;
    }
},

    printSaleRecordFromHistory(firestoreId) {
        const saleToPrint = this.state.salesHistory.find(s => s.firestoreId === firestoreId);
        if (saleToPrint) {
            this.printReceipt(saleToPrint);
        } else {
            this.showInfoModal("ผิดพลาด", "ไม่พบข้อมูลการขายสำหรับพิมพ์", true);
        }
    },
    
    printReceipt(saleRecord) {
        const { storeName, address, phone, taxId } = this.state.receiptSettings;
        const receiptWindow = window.open('', 'PRINT', 'height=600,width=400');

        receiptWindow.document.write('<html><head><title>ใบเสร็จ</title>');
        receiptWindow.document.write('<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">');
        receiptWindow.document.write('<style>');
        receiptWindow.document.write(`
            body { 
                font-family: 'Sarabun', monospace; 
                margin: 0; 
                padding: 15px; 
                font-size: 10pt; 
             
                   line-height: 1.5;
                background-color: #fff;
                color: #000;
            }
            .receipt-container { 
                width: 100%; 
                max-width: 320px; 

                margin: auto; 
            }
            .header {
                text-align: center;
                margin-bottom: 15px;
            }
           
             .header h2 {
                margin: 0;
                font-size: 1.4em;
            }
            .header p {
                margin: 2px 0;
                font-size: 0.9em;
  
                     }
            .info-table, .summary-table {
                width: 100%;
                font-size: 0.9em;
            }
            .info-table td:last-child, .summary-table td:last-child {
              
                 text-align: right;
            }
            .items-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            .items-table thead tr {
                border-top: 1px dashed #000;
                border-bottom: 1px dashed #000;
            }
            .items-table th {
                text-align: left;
                padding: 5px 0;
            }
            .items-table th:last-child {
                text-align: right;
            }
            .items-table td {
                padding: 3px 0;
                vertical-align: top;
            }
            .item-name {
                word-break: break-all;
            }
            .item-details {
                text-align: right;
                white-space: nowrap;
            }
            .summary-section {
                margin-top: 10px;
                border-top: 1px dashed #000;
                padding-top: 5px;
            }
            .summary-table .total-row td {
                font-weight: bold;
                font-size: 1.1em;
                padding-top: 5px;
            }
            .footer {
                text-align: center;
                margin-top: 20px;
                font-size: 0.9em;
            }
        `);
        receiptWindow.document.write('</style></head><body>');
        const itemsHtml = saleRecord.items.map(item => `
            <tr>
                <td class="item-name">${this.escapeHtml(item.name)}</td>
                <td class="item-details">${item.quantity}</td>
                <td class="item-details">${(item.quantity * item.price).toFixed(2)}</td>
            </tr>
        `).join('');
        const receiptContent = `
            <div class="receipt-container">
                <div class="header">
                    <h2>${this.escapeHtml(storeName) ||
                    'ชื่อร้านค้า'}</h2>
                    <p>${this.escapeHtml(address) ||
                    'ที่อยู่'}</p>
                    <p>${this.escapeHtml(phone) ?
                    'โทร: ' + this.escapeHtml(phone) : ''}</p>
                    <p>${this.escapeHtml(taxId) ?
                    'เลขประจำตัวผู้เสียภาษี: ' + this.escapeHtml(taxId) : ''}</p>
                </div>

                <table class="info-table">
                    <tr>
                        <td>เลขที่ใบเสร็จ:</td>
                  
                     <td>${saleRecord.id}</td>
                    </tr>
                    <tr>
                        <td>วันที่:</td>
                        <td>${new Date(saleRecord.timestamp).toLocaleString('th-TH')}</td>
     
                                   </tr>
                </table>

                <table class="items-table">
                        <thead>
                            
                             <tr>
                                    <th>รายการ</th>
                                    <th>จำนวน</th>
                        
                             <th>ราคา</th>
                                </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
    
                         </tbody>
                </table>
                
                <div class="summary-section">
                    <table class="summary-table">
                  
                         <tr>
                                <td>รวมเป็นเงิน</td>
                                <td>${saleRecord.subtotal.toFixed(2)}</td>
                          
                   </tr>
                            <tr>
                                <td>ส่วนลด</td>
                                <td>${saleRecord.discount.toFixed(2)}</td>
      
                                     </tr>
                            <tr class="total-row">
                                <td>ยอดสุทธิ</td>
                 
                               <td>${saleRecord.total.toFixed(2)}</td>
                            </tr>
                             <tr>
                            
                             <td>รับเงินสด</td>
                                <td>${saleRecord.cashReceived.toFixed(2)}</td>
                            </tr>
                             <tr>
       
                                     <td>เงินทอน</td>
                                <td>${saleRecord.change.toFixed(2)}</td>
                            </tr>
               
                 </table>
                </div>

                <div class="footer">
                    <p>*** ขอบคุณที่ใช้บริการ ***</p>
                </div>
            </div>
        `;
        receiptWindow.document.write(receiptContent);
        receiptWindow.document.write('</body></html>');
        receiptWindow.document.close();
        receiptWindow.focus();

        setTimeout(() => {
            receiptWindow.print();
            receiptWindow.close();
        }, 250);
    },
    
    async editSaleRecord(firestoreId) {
        if (this.state.tabs.size >= 5) { this.showInfoModal("ไม่สามารถแก้ไข", "เปิดบิลครบ 5 บิลแล้ว ไม่สามารถเปิดบิลเพื่อแก้ไขได้", true);
        return; }
        const saleToEdit = this.state.salesHistory.find(s => s.firestoreId === firestoreId);
        if (!saleToEdit) { this.showInfoModal("ผิดพลาด", "ไม่พบข้อมูลการขายที่ต้องการแก้ไข", true); return; }
        const newCart = [];
        const missingItems = [];
        for (const item of saleToEdit.items) {
            const fullProductUnit = this.state.searchableProductUnits.find(p => p.cartItemId === item.cartItemId);
            if (fullProductUnit) {
                const cartItem = { cartItemId: item.cartItemId, productUnit: fullProductUnit, quantity: item.quantity };
                const originalPrice = this.calculateItemTotal(fullProductUnit.pricingUnit, item.quantity) / item.quantity;
                if (Math.abs(item.price - originalPrice) > 0.001) {
                    cartItem.priceOverride = item.price;
                }
                newCart.push(cartItem);
            } else {
                missingItems.push(item.name);
            }
        }
        if (missingItems.length > 0) { this.showInfoModal("คำเตือน", `ไม่พบสินค้าบางรายการในระบบปัจจุบันและจะไม่ถูกเพิ่มในตะกร้า:\n- ${missingItems.join('\n- ')}`);
        }
        if (newCart.length === 0) { this.showInfoModal("ผิดพลาด", "ไม่สามารถนำรายการสินค้าในบิลเก่ามาแก้ไขได้ทั้งหมด", true); return;
        }
        const tabId = this.addNewSaleTab(`บิลแก้ไข #${saleToEdit.id.slice(-4)}`);
        const tabData = this.state.tabs.get(tabId);
        tabData.cart = newCart;
        tabData.discount = saleToEdit.discount || 0;
        tabData.isEditing = true;
        tabData.originalFirestoreId = firestoreId;
        document.getElementById('edit-status').innerHTML = `กำลังแก้ไขบิล <strong>${saleToEdit.id}</strong>. เมื่อชำระเงิน, บิลเก่าจะถูกลบและสร้างบิลใหม่.`;
        document.getElementById('edit-status').style.display = 'block';
        this.updateCartDisplay();
        this.hideHistoryModal();
    },
    showDeleteConfirmModal(id, isTab) { 
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const confirmText = document.getElementById('delete-confirm-text'); 
        if (isTab) { 
            const tabData = this.state.tabs.get(id);
            confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการปิดบิล '${tabData.name}'?`; 
            confirmBtn.onclick = () => { this.closeTab(id, false); this.hideDeleteConfirmModal(); };
        } else { 
            const sale = this.state.salesHistory.find(s => s.firestoreId === id);
            confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบรายการขาย ID: ${sale ? sale.id : id}? การกระทำนี้ไม่สามารถย้อนกลับได้`; 
            confirmBtn.onclick = () => this.executeDeleteSaleFromHistory(id);
        } 
        document.getElementById('delete-confirm-modal').style.display = 'flex'; 
        setTimeout(() => confirmBtn.focus(), 50);
    },
    hideDeleteConfirmModal() { document.getElementById('delete-confirm-modal').style.display = 'none'; },
    async executeDeleteSaleFromHistory(firestoreId) { 
        const {api, db} = window.firebaseServices;
        const docRef = api.doc(db, this.getSalesHistoryCollectionRef().path, firestoreId); 
        this.hideDeleteConfirmModal(); 
        try { 
            await api.deleteDoc(docRef);
            console.log("Deleted sale record:", firestoreId); 
        } catch (e) { 
            console.error("Error deleting document: ", e);
            this.showInfoModal("ผิดพลาด", "เกิดข้อผิดพลาดในการลบข้อมูล!", true); 
        } 
    },
    showClearOptionsModal() { document.getElementById('clear-options-modal').style.display = 'flex';
    },
    hideClearOptionsModal() { document.getElementById('clear-options-modal').style.display = 'none'; },
    clearHistoryLocally() { 
        this.state.salesHistory = [];
        this.updateHistoryDisplay(); 
        this.hideClearOptionsModal(); 
    },
    async executeClearAllHistory() { 
        this.hideClearOptionsModal();
        const salesCollection = this.getSalesHistoryCollectionRef(); 
        try { 
            const querySnapshot = await window.firebaseServices.api.getDocs(salesCollection);
            const batch = window.firebaseServices.api.writeBatch(window.firebaseServices.db); 
            querySnapshot.forEach((doc) => { batch.delete(doc.ref); }); 
            await batch.commit();
        } catch (e) { 
            this.showInfoModal("ผิดพลาด", "เกิดข้อผิดพลาดในการล้างประวัติทั้งหมด!", true);
        } 
    },
    updateHistoryDisplay() {
        const historyBody = document.getElementById('history-body');
        if (!historyBody) return;
        const searchFilter = document.getElementById('history-search-input').value.toLowerCase().trim();
        const filteredHistory = this.state.salesHistory.filter(sale => {
            const saleIdMatch = sale.id.toLowerCase().includes(searchFilter);
            const itemMatch = sale.items.some(item => item.name.toLowerCase().includes(searchFilter));
            return searchFilter === '' || saleIdMatch || itemMatch;
        });
        historyBody.innerHTML = '';

        // === Product search count summary [enhanced] ===
        (function () {
            const summaryEl = document.getElementById('history-product-count');
            if (!summaryEl) return;

            const q = (searchFilter || '').trim();
            if (!q) { summaryEl.style.display = 'none'; summaryEl.innerHTML = ''; return; }

            let totalSellingQty = 0;
            let totalBaseQty = 0;
            const sellingUnits = new Set();
            const baseUnits = new Set();
            let matchedAny = false;

            // iterate only items that match product name, not sale id
            filteredHistory.forEach(sale => {
                (sale.items || []).forEach(item => {
                    const name = (item.productName || item.name || '').toLowerCase();
                    if (!name.includes(q)) return;

                    matchedAny = true;
                    const qty = Number(item.quantity) || 0;
                    const unitName = item.unit || item.sellingUnit || (item.pricingUnit && item.pricingUnit.unitName) || '';
                    const conv = Number(item.conversionFactor) || 1;
                    const baseName = item.baseUnit || unitName || 'หน่วย';

                    totalSellingQty += qty;
                    totalBaseQty += qty * conv;
                    if (unitName) sellingUnits.add(unitName);
                    if (baseName) baseUnits.add(baseName);
                });
            });

            if (!matchedAny) { summaryEl.style.display = 'none'; summaryEl.innerHTML = ''; return; }

            // Build date-range label
            const startDate = document.getElementById('start-date')?.value;
            const endDate = document.getElementById('end-date')?.value;
            let rangeText = '';
            if (startDate && endDate) {
                try {
                    const s = new Date(startDate);
                    const e = new Date(endDate);
                    rangeText = `ในช่วง ${s.toLocaleDateString('th-TH')} – ${e.toLocaleDateString('th-TH')}`;
                } catch (_) { /* ignore */ }
            }

            // Prefer selling unit if consistent, else show base unit
            let mainLine = '';
            if (sellingUnits.size === 1) {
                const u = Array.from(sellingUnits)[0];
                mainLine = `สินค้า “${this.escapeHtml(document.getElementById('history-search-input').value)}” ขายรวม ${totalSellingQty} ${u} ${rangeText}`;
                // If base unit differs and conversion applied, append base summary
                if (baseUnits.size === 1) {
                    const bu = Array.from(baseUnits)[0];
                    if (bu && bu !== u) {
                        mainLine += ` (เทียบเท่า ${totalBaseQty} ${bu})`;
                    }
                }
            } else {
                // Mixed selling units. Report only in base units if consistent
                if (baseUnits.size >= 1) {
                    const bu = Array.from(baseUnits)[0];
                    mainLine = `สินค้า “${this.escapeHtml(document.getElementById('history-search-input').value)}” ขายรวม ${totalBaseQty} ${bu} ${rangeText}`;
                    if (baseUnits.size > 1) {
                        mainLine += ` (หลายหน่วยฐาน)`;
                    }
                } else {
                    // Fallback
                    mainLine = `สินค้า “${this.escapeHtml(document.getElementById('history-search-input').value)}” ขายรวม ${totalSellingQty} หน่วย ${rangeText}`;
                }
            }

            summaryEl.innerHTML = `<div class="label" style="font-weight:bold;color:var(--secondary-color);margin-bottom:0.25rem;">สรุปตามคำค้น</div><div class="value" style="font-size:1.1em;color:var(--dark-text);">${mainLine}</div>`;
            summaryEl.style.display = 'block';
        }).call(this);
// replaced by enhanced version


        const now = new Date();
        const startOfCurrentHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
        if (filteredHistory.length === 0) {
            historyBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">ไม่พบประวัติการขายที่ตรงกับเงื่อนไข</td></tr>';
        } else {
            filteredHistory.forEach((sale) => {
                const row = historyBody.insertRow();
                const saleTimestamp = new Date(sale.timestamp);
                if (saleTimestamp < startOfCurrentHour) {
                    row.classList.add('exported-row');
     
                                   row.title = 'รายการนี้ถูก Export แล้วโดยระบบอัตโนมัติ';
                }
const itemDetails = sale.items.map(item => {
  const name = this.escapeHtml(item.name);
  return `${name} (x${item.quantity})`;
}).join('<br>');

                const discountAmount = sale.discount ? sale.discount.toFixed(2) : '0.00';
                
                let adminActions = `<button type="button" class="edit-history-btn" onclick="POS_APP.editSaleRecord('${sale.firestoreId}')">แก้ไข</button><button type="button" class="delete-history-btn" onclick="POS_APP.showDeleteConfirmModal('${sale.firestoreId}', false)">ลบ</button>`;
                let actionCellHTML 
                = `<button type="button" class="print-history-btn" onclick="POS_APP.printSaleRecordFromHistory('${sale.firestoreId}')">พิมพ์</button>`;
                
                if (!this.state.isRestrictedMode) {
                    actionCellHTML += adminActions;
                }
                
                row.innerHTML = `<td>${new Date(sale.timestamp).toLocaleString('th-TH')}</td><td>${sale.id}</td><td>${itemDetails}</td><td>${discountAmount}</td><td><strong>${sale.total.toFixed(2)}</strong></td><td style="white-space: nowrap;">${actionCellHTML}</td>`;
            });
        }
        const clearHistoryBtn = document.getElementById('clear-all-history-btn');
        if(clearHistoryBtn) clearHistoryBtn.disabled = this.state.salesHistory.length === 0;
        this.calculateSummaryForDisplayedHistory(filteredHistory);
    },
    calculateSummaryForDisplayedHistory(displayedSales = []) { 
        let totalSales = 0, totalDiscount = 0, netSales = 0, totalCost = 0;
        displayedSales.forEach(sale => { 
            totalSales += sale.subtotal || 0; 
            totalDiscount += sale.discount || 0; 
            netSales += sale.total || 0; 
            if (sale.items && Array.isArray(sale.items)) { 
                sale.items.forEach(item => { 
          
                     totalCost += (item.cost || 0) * (item.quantity || 0); 
                }); 
            } 
        });
        const billCount = displayedSales.length; 
        const profit = netSales - totalCost;
        const formatCurrency = (n) => n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
        
        document.getElementById('summary-total-sales').textContent = formatCurrency(totalSales);
        document.getElementById('summary-total-discount').textContent = formatCurrency(totalDiscount);
        document.getElementById('summary-net-sales').textContent = formatCurrency(netSales);
        document.getElementById('summary-bill-count').textContent = billCount.toLocaleString('en-US');
        document.getElementById('summary-profit').textContent = formatCurrency(profit);
    },
    toggleUIVisibility() { 
        const summarySection = document.getElementById('sales-summary-section');
        const searchInput = document.getElementById('barcode-input');
        if (summarySection && searchInput) {
            const isSearching = searchInput.value.trim().length > 0;
            const shouldShow = !this.state.isRestrictedMode && !isSearching;
            summarySection.style.display = shouldShow ? 'block' : 'none';
        }
        this.updateHistoryDisplay();
        this.updateCartDisplay();
    },
    addNewSaleTab(customName = '') {
        if (this.state.tabs.size >= 5) { this.showInfoModal("ไม่สามารถเปิดบิล", "ไม่สามารถเปิดบิลใหม่ได้เกิน 5 บิล", false);
        return null; }
        let tabName = customName;
        if (!tabName) {
            let nextSaleNumber = 1;
            const usedNumbers = Array.from(this.state.tabs.values()).map(t => t.name ? parseInt(t.name.split(' ')[1]) : 0);
            while(usedNumbers.includes(nextSaleNumber)) { nextSaleNumber++;
            }
            tabName = `บิล ${nextSaleNumber}`;
        }
        const tabId = 'sale-' + Date.now();
        this.state.tabs.set(tabId, { cart: [], discount: 0, name: tabName, isEditing: false, originalFirestoreId: null });
        this.renderTabs();
        this.switchTab(tabId);
        return tabId;
    },
    switchTab(tabId) { 
        if (!this.state.tabs.has(tabId)) return; 
        this.state.activeTabId = tabId;
        this.renderTabs(); 
        this.updateCartDisplay(); 
        this.focusSearchIfReady(); 
    },
    closeTab(tabId, confirm = true) {
        const tabData = this.state.tabs.get(tabId);
        if (!tabData) return;
        if (tabData.isEditing) { document.getElementById('edit-status').style.display = 'none'; }
        if (confirm && tabData.cart.length > 0) { this.showDeleteConfirmModal(tabId, true);
        return; }
        this.state.tabs.delete(tabId);
        if (this.state.activeTabId === tabId) {
            const remainingTabs = Array.from(this.state.tabs.keys());
            if (remainingTabs.length > 0) {
                this.switchTab(remainingTabs[0]);
            } else {
                this.addNewSaleTab();
            }
        }
        this.renderTabs();
    },
    renderTabs() { 
        const tabsContainer = document.getElementById('cart-tabs');
        if (!tabsContainer) return; 
        tabsContainer.innerHTML = ''; 
        const self = this;
        this.state.tabs.forEach((data, id) => { 
            const tabButton = document.createElement('button'); 
            tabButton.type = 'button';
            tabButton.className = 'tab-button'; 
            tabButton.textContent = data.name; 
            tabButton.onclick = () => self.switchTab(id); 
            if (id === this.state.activeTabId) { tabButton.classList.add('active'); } 

            if (this.state.tabs.size > 1) { 
                const closeButton = document.createElement('button'); 
                closeButton.type = 'button';
                closeButton.className = 'close-tab-btn'; 
                closeButton.textContent = '×';
        
                 closeButton.onclick = (e) => { e.stopPropagation(); self.closeTab(id); }; 
                tabButton.appendChild(closeButton); 
            } 
            tabsContainer.appendChild(tabButton); 
        });
    },
    navigateTabs(direction) { 
        const tabKeys = Array.from(this.state.tabs.keys());
        if(tabKeys.length <= 1) return; 
        let currentIndex = tabKeys.indexOf(this.state.activeTabId); 
        currentIndex += direction; 
        if (currentIndex >= tabKeys.length) { currentIndex = 0;
        } 
        else if (currentIndex < 0) { currentIndex = tabKeys.length - 1;
        } 
        this.switchTab(tabKeys[currentIndex]);
    },
    filterHistoryByDateTime() { 
        const startDateInput = document.getElementById('start-date').value; 
        const startTimeInput = document.getElementById('start-time').value;
        const endDateInput = document.getElementById('end-date').value; 
        const endTimeInput = document.getElementById('end-time').value;

        if (!startDateInput || !endDateInput) { 
            this.showInfoModal("ข้อมูลไม่ครบถ้วน", "กรุณาเลือกทั้งวันที่เริ่มต้นและวันที่สิ้นสุด", false);
            return; 
        } 

        const startTime = startTimeInput || '00:00:00';
        const endTime = endTimeInput || '23:59:59';
        
        const startDateTime = new Date(`${startDateInput}T${startTime}`);
        const endDateTime = new Date(`${endDateInput}T${endTime}`);

        this.loadSalesHistoryFromFirestore(startDateTime.toISOString(), endDateTime.toISOString());
    },
    filterHistoryForToday() { 
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0); 
        const todayEnd = new Date(); 
        todayEnd.setHours(23, 59, 59, 999); 

        document.getElementById('start-date').valueAsDate = todayStart;
        document.getElementById('end-date').valueAsDate = todayEnd;
        document.getElementById('start-time').value = '00:00';
        document.getElementById('end-time').value = '23:59';

        document.getElementById('history-search-input').value = '';
        this.loadSalesHistoryFromFirestore(todayStart.toISOString(), todayEnd.toISOString());
    },
    loadSalesHistoryFromFirestore(startDate, endDate) { 
        const historyCollectionRef = this.getSalesHistoryCollectionRef();
        if (!historyCollectionRef) return; 
        if (this.state.unsubscribeSalesHistory) { this.state.unsubscribeSalesHistory(); } 
        const { query, where } = window.firebaseServices.api;
        let q; 
        if (startDate && endDate) { 
            q = query(historyCollectionRef, where("timestamp", ">=", startDate), where("timestamp", "<=", endDate) );
        } else { 
            q = query(historyCollectionRef);
        } 
        this.state.unsubscribeSalesHistory = window.firebaseServices.api.onSnapshot(q, (querySnapshot) => { 
            const newHistory = []; 
            querySnapshot.forEach((doc) => { newHistory.push({ ...doc.data(), firestoreId: doc.id }); }); 
            this.state.salesHistory = newHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
            this.updateHistoryDisplay(); 
        }, (error) => { 
 
                   console.error("Error loading sales history:", error); 
            if (error.code === 'permission-denied') { this.showInfoModal("ข้อผิดพลาด Firestore", "การเชื่อมต่อ Firestore ล้มเหลว! (permission-denied)", true); } 
        });
    },
    async generateSaleId() { 
        const today = new Date();
        const datePrefix = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`; 
        if (this.state.lastSaleDate !== datePrefix) { 
            this.state.dailySaleCounter = 0;
            this.state.lastSaleDate = datePrefix; 
        } 
        const todaySalesInHistory = this.state.salesHistory.filter(sale => sale.id && sale.id.startsWith(datePrefix));
        this.state.dailySaleCounter = todaySalesInHistory.length + 1; 
        return `${datePrefix}-${this.state.dailySaleCounter.toString().padStart(4, '0')}`; 
    },
    exportToExcel() {
        const dataToExport = this.state.salesHistory.flatMap(sale =>
            sale.items.map(item => {
                let productName = item.name, unit = item.unit, quantity = item.quantity, pricePerBaseUnit = 'N/A', costPerBaseUnit = 'N/A';
                if (item.conversionFactor && item.baseUnit) {
          
                         productName = item.productName;
                    unit = item.baseUnit;
                    quantity = item.quantity * item.conversionFactor;
                    pricePerBaseUnit = (item.price / item.conversionFactor).toFixed(4);
                  
                     costPerBaseUnit = (item.costPerBaseUnit || 0).toFixed(4);
                } else {
                    const fullProductUnit = this.state.searchableProductUnits.find(p => p.cartItemId === item.cartItemId);
                    if (fullProductUnit && fullProductUnit.pricingUnit) {
                        const 
                        conversionFactor = fullProductUnit.pricingUnit.conversionFactor || 1;
                        const costPerSellingUnit = fullProductUnit.pricingUnit.cost ||
                        0;
                        productName = fullProductUnit.productName;
                        unit = fullProductUnit.baseUnit;
                        quantity = item.quantity * conversionFactor;
                        pricePerBaseUnit = (item.price / conversionFactor).toFixed(4);
                        costPerBaseUnit = (costPerSellingUnit / conversionFactor).toFixed(4);
                    }
                }
                return {
                    'รหัสการขาย': sale.id, 'วันที่': new Date(sale.timestamp).toLocaleDateString('th-TH'), 'เวลา': new Date(sale.timestamp).toLocaleTimeString('th-TH'),
                    'ยอดรวมก่อนลด': sale.subtotal ?
                    sale.subtotal.toFixed(2) : '0.00', 'ส่วนลด': sale.discount ? sale.discount.toFixed(2) : '0.00',
                    'ยอดสุทธิ': sale.total ?
                    sale.total.toFixed(2) : '0.00', 'สินค้า': productName, 'หน่วย': unit, 'จำนวน (หน่วยเล็กที่สุด)': quantity,
                    'มูลค่ารวม (รายการนี้)': (item.price * item.quantity).toFixed(2), 'ราคาต่อหน่วยเล็กที่สุด': pricePerBaseUnit, 'ต้นทุนต่อหน่วยเล็กที่สุด': costPerBaseUnit
                };
            })
        );
        if (dataToExport.length === 0) { this.showInfoModal("ไม่มีข้อมูล", "ไม่มีข้อมูลประวัติการขายให้ Export", false); return;
        }
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ประวัติการขาย (หน่วยเล็ก)');
        worksheet['!cols'] = [ { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 } ];
        XLSX.writeFile(workbook, `pos-history-base-units-${new Date().toISOString().split('T')[0]}.xlsx`);
    },

    async loadReceiptSettings() {
        const { api } = window.firebaseServices;
        const docRef = this.getReceiptSettingsDocRef();
        try {
            const docSnap = await api.getDoc(docRef);
            if (docSnap.exists()) {
                this.state.receiptSettings = docSnap.data();
            } else {
                this.state.receiptSettings = { storeName: '', address: '', phone: '', taxId: '' };
            }
        } catch(e) {
            console.error("Error loading receipt settings:", e);
            this.state.receiptSettings = { storeName: '', address: '', phone: '', taxId: '' };
        }
    },
    async saveReceiptSettings() {
        const { api } = window.firebaseServices;
        const docRef = this.getReceiptSettingsDocRef();
        const newSettings = {
            storeName: document.getElementById('receipt-store-name').value,
            address: document.getElementById('receipt-address').value,
            phone: document.getElementById('receipt-phone').value,
            taxId: document.getElementById('receipt-tax-id').value,
        };
        try {
            await api.setDoc(docRef, newSettings, { merge: true });
            this.state.receiptSettings = newSettings;
            this.hideReceiptSettingsModal();
            this.showInfoModal("สำเร็จ", "บันทึกข้อมูลใบเสร็จเรียบร้อยแล้ว");
        } catch(e) {
            console.error("Error saving receipt settings:", e);
            this.showInfoModal("ผิดพลาด", "ไม่สามารถบันทึกการตั้งค่าได้", true);
        }
    },
    showReceiptSettingsModal() {
        const { storeName, address, phone, taxId } = this.state.receiptSettings;
        document.getElementById('receipt-store-name').value = storeName || '';
        document.getElementById('receipt-address').value = address || '';
        document.getElementById('receipt-phone').value = phone || '';
        document.getElementById('receipt-tax-id').value = taxId || '';
        document.getElementById('receipt-settings-modal').style.display = 'flex';
    },
    hideReceiptSettingsModal() {
        document.getElementById('receipt-settings-modal').style.display = 'none';
    },

    // ✅ [NEW] ฟังก์ชันใหม่สำหรับ Sync ข้อมูลตอนกลับมา Online
    async syncOfflineSales() {
        if (!window.OfflineQueue) return;
        
        console.log("Connection restored. Attempting to sync offline sales...");
        this.showInfoModal("กำลังเชื่อมต่อ...", "กลับมาออนไลน์แล้ว กำลังส่งข้อมูลการขายที่ค้างอยู่...", false);

        const { api, db } = window.firebaseServices;
        const salesCollectionRef = this.getSalesHistoryCollectionRef();
        const productsCollectionRef = this.getProductsCollectionRef();

        // ใช้ Handler เพื่อจัดการกับแต่ละ item ใน Queue
        window.OfflineQueue.flush(async (op) => {
            if (op.type === 'sale') {
                const saleRecord = op.payload;
                const tabData = op.tabData;
                
                try {
                    const batch = api.writeBatch(db);

                    // อัปเดตสต็อกสินค้า
                    for (const item of saleRecord.items) {
                        const productRef = api.doc(productsCollectionRef, item.productId);
                        // ดึงข้อมูลสต็อกล่าสุดก่อนอัปเดต (เพื่อความปลอดภัย)
                        const productSnap = await api.getDoc(productRef);
                        if (productSnap.exists()) {
                            const currentStock = productSnap.data().stockInBaseUnits || 0;
                            const quantityInBaseUnits = item.quantity * (item.conversionFactor || 1);
                            const newStock = currentStock - quantityInBaseUnits;
                            batch.update(productRef, { stockInBaseUnits: newStock });
                        }
                    }

                    // สร้าง/แก้ไขบิล
                    if (tabData.isEditing && tabData.originalFirestoreId) {
                        const oldSaleRef = api.doc(db, salesCollectionRef.path, tabData.originalFirestoreId);
                        const newSaleRef = api.doc(salesCollectionRef);
                        batch.delete(oldSaleRef);
                        batch.set(newSaleRef, saleRecord);
                    } else {
                        const newSaleDocRef = api.doc(salesCollectionRef);
                        batch.set(newSaleDocRef, saleRecord);
                    }

                    await batch.commit();
                    console.log(`Successfully synced offline sale ID: ${saleRecord.id}`);

                } catch (syncError) {
                    console.error(`Failed to sync offline sale ID: ${saleRecord.id}`, syncError);
                    // หากล้มเหลวอีกครั้ง ให้ push กลับเข้าไปใน Queue เพื่อลองใหม่ครั้งหน้า
                    window.OfflineQueue.push(op);
                }
            }
        });

        // หน่วงเวลาเล็กน้อยแล้วซ่อน Modal
        setTimeout(() => {
           this.hideInfoModal();
        }, 2500);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    window.POS_APP = POS_APP;
    POS_APP.init();
});
</script>
<script>
(function(){
  function setVh(){
    var vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVh();
  window.addEventListener('resize', setVh, {passive:true});
  window.addEventListener('orientationchange', setVh);
})();
</script>
<!-- Patch: toggle .has-text on history search input -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  var hsi = document.getElementById('history-search-input');
  if (hsi) {
    var wrap = hsi.closest('.input-with-icon');
    function update() {
      if (wrap) {
        var hasText = hsi.value.trim() !== '';
        if (hasText) { wrap.classList.add('has-text'); }
        else { wrap.classList.remove('has-text'); }
      }
    }
    hsi.addEventListener('input', update);
    // Initial state on load
    update();
  }
});
</script>
<!-- End Patch -->
</body></html>

<script>
// === Augmented: clear history by selected date-time range ===
(function(){
  // Define once
  if (window.__pos09_range_bootstrap__) return;
  window.__pos09_range_bootstrap__ = true;

  function installInto(app){
    if (!app) return false;

    // Helper: parse range
    if (typeof app.getSelectedDateRangeISO !== 'function') {
      app.getSelectedDateRangeISO = function() {
        const sd = document.getElementById('start-date')?.value;
        const ed = document.getElementById('end-date')?.value;
        const st = document.getElementById('start-time')?.value || '00:00';
        const et = document.getElementById('end-time')?.value || '23:59';
        if (!sd || !ed) {
          this.showInfoModal?.("ช่วงเวลาไม่ครบ", "กรุณาเลือกวันที่เริ่มและสิ้นสุดก่อนล้างประวัติ", true);
          throw new Error("range-missing");
        }
        const start = new Date(`${sd}T${st}`);
        const end   = new Date(`${ed}T${et}`);
        if (!(start instanceof Date) || isNaN(start) || !(end instanceof Date) || isNaN(end) || end < start) {
          this.showInfoModal?.("ช่วงเวลาไม่ถูกต้อง", "โปรดตรวจสอบวันที่และเวลาให้ถูกต้อง", true);
          throw new Error("range-invalid");
        }
        return { start, end, startISO: start.toISOString(), endISO: end.toISOString() };
      };
    }

    // Local clear
    app.clearHistoryLocallyByRange = function() {
      let range;
      try { range = this.getSelectedDateRangeISO(); } catch(e) { return; }
      const { start, end } = range;
      const before = Array.isArray(this.state?.salesHistory) ? this.state.salesHistory.length : 0;
      if (!Array.isArray(this.state?.salesHistory)) this.state = { ...(this.state||{}), salesHistory: [] };
      this.state.salesHistory = this.state.salesHistory.filter(s => {
        const t = new Date(s.timestamp).getTime();
        if (isNaN(t)) return true;
        return t < start.getTime() || t > end.getTime();
      });
      const after = this.state.salesHistory.length;
      const removed = Math.max(0, before - after);
      this.updateHistoryDisplay?.();
      this.hideClearOptionsModal?.();
      this.showInfoModal?.("สำเร็จ", `ล้างเฉพาะหน้าแล้ว ${removed} บิล ในช่วงที่เลือก`, false);
    };

    // DB clear
    app.executeClearHistoryByRange = async function() {
      let range;
      try { range = this.getSelectedDateRangeISO(); } catch(e) { return; }
      this.hideClearOptionsModal?.();
      const { start, end, startISO, endISO } = range;
      const services = window.firebaseServices || {};
      const api = services.api;
      const db = services.db;
      const salesCollection = this.getSalesHistoryCollectionRef?.();
      if (!api || !db || !salesCollection) {
        this.showInfoModal?.("ผิดพลาด", "ไม่พบการตั้งค่าฐานข้อมูล", true);
        return;
      }
      try {
        const querySnapshot = await api.getDocs(salesCollection);
        const batch = api.writeBatch(db);
        let toDelete = 0;
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const ts = data && data.timestamp;
          if (typeof ts === 'string' && ts >= startISO && ts <= endISO) {
            batch.delete(doc.ref);
            toDelete += 1;
          }
        });
        if (toDelete > 0) await batch.commit();
        if (Array.isArray(this.state?.salesHistory)) {
          this.state.salesHistory = this.state.salesHistory.filter(s => {
            const t = new Date(s.timestamp).getTime();
            if (isNaN(t)) return true;
            return t < start.getTime() || t > end.getTime();
          });
          this.updateHistoryDisplay?.();
        }
        this.showInfoModal?.("สำเร็จ", `ล้างจากฐานข้อมูลแล้ว ${toDelete} บิล ในช่วงที่เลือก`, false);
      } catch (e) {
        console.error("executeClearHistoryByRange error:", e);
        this.showInfoModal?.("ผิดพลาด", "เกิดข้อผิดพลาดในการล้างประวัติตามช่วงเวลา", true);
      }
    };

    return true;
  }

  function ensure(){
    const app = window.POS_APP;
    if (!app) return false;
    return installInto(app);
  }

  if (!ensure()) {
    // Try on DOM ready and window load
    document.addEventListener('DOMContentLoaded', ensure);
    window.addEventListener('load', ensure);
    // Poll for late creation of POS_APP
    const t = setInterval(() => { if (ensure()) clearInterval(t); }, 150);
    // Optional: if app exposes a ready event
    try { window.addEventListener('posapp-ready', ensure); } catch(_e) {}
  }
})();
</script>

